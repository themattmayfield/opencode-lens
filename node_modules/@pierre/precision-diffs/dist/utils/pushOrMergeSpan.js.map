{"version":3,"file":"pushOrMergeSpan.js","names":["annotations: AnnotationSpan[]","spanMarkers: (AnnotationSpan | 0)[]","newSpans: LineSpans[]"],"sources":["../../src/utils/pushOrMergeSpan.ts"],"sourcesContent":["import type { AnnotationSpan, LineInfo, LineSpans } from '../types';\n\nexport function pushOrMergeSpan(\n  span: LineSpans | undefined,\n  index: number,\n  spanMap: Record<number, LineInfo | undefined>\n): void {\n  if (span == null) {\n    return;\n  }\n  let lineInfo = spanMap[index];\n  // If we need to inject a gap at the top of a column, then we'll make a\n  // `fake` lineInfo for it.\n  if (lineInfo == null && index === 0 && span.type === 'gap') {\n    lineInfo = {\n      type: 'context',\n      lineNumber: -1,\n      lineIndex: -1,\n      spans: [],\n    };\n    spanMap[0] = lineInfo;\n  } else if (lineInfo == null) {\n    console.error('pushOrMergeSpan: Attempting to apply an invalid span', {\n      span,\n      index,\n      spanMap,\n    });\n    return;\n  }\n  const spans = lineInfo.spans ?? [];\n  lineInfo.spans = spans;\n  if (spans.length === 0) {\n    spans.push(span);\n  }\n  // If we get in here, we may need to split up some gaps to split up some gaps\n  else {\n    let gapSize = span.type === 'gap' ? span.rows : 0;\n    const annotations: AnnotationSpan[] = [];\n    let merged = false;\n    for (const item of spans) {\n      if (item.type === 'annotation') {\n        if (span.type === 'annotation' && span.lineIndex === item.lineIndex) {\n          merged = true;\n          item.annotations = mergeAnnotations(\n            item.annotations,\n            span.annotations\n          );\n        }\n        annotations.push(item);\n      } else {\n        gapSize += item.rows;\n      }\n    }\n    if (span.type === 'annotation' && !merged) {\n      annotations.push(span);\n    }\n    const spanMarkers: (AnnotationSpan | 0)[] = new Array(gapSize).fill(0);\n    for (const annotation of annotations) {\n      const annotationIndex = annotation.lineIndex - lineInfo.lineIndex;\n      const currentItem = spanMarkers[annotationIndex];\n      if (currentItem === 0 || currentItem == null) {\n        spanMarkers.splice(annotationIndex, 0, annotation);\n      } else {\n        // NOTE(amadeus): Hopefully we never get in here, but theoretically\n        // it's possible... so we'll merge the annotations together\n        currentItem.annotations = mergeAnnotations(\n          currentItem.annotations,\n          annotation.annotations\n        );\n      }\n    }\n    const newSpans: LineSpans[] = [];\n    let spanSize = 0;\n    for (const item of spanMarkers) {\n      if (item === 0) {\n        spanSize++;\n      } else {\n        if (spanSize > 0) {\n          newSpans.push({ type: 'gap', rows: spanSize });\n          spanSize = 0;\n        }\n        newSpans.push(item);\n      }\n    }\n    if (spanSize > 0) {\n      newSpans.push({ type: 'gap', rows: spanSize });\n    }\n    lineInfo.spans = newSpans;\n  }\n}\n\nfunction mergeAnnotations(base: string[], newAnnotations: string[]): string[] {\n  if (newAnnotations.length === 0) {\n    return base;\n  }\n  const baseSet = new Set(base);\n  for (const item of newAnnotations) {\n    baseSet.add(item);\n  }\n  return Array.from(baseSet);\n}\n"],"mappings":";AAEA,SAAgB,gBACd,MACA,OACA,SACM;AACN,KAAI,QAAQ,KACV;CAEF,IAAI,WAAW,QAAQ;AAGvB,KAAI,YAAY,QAAQ,UAAU,KAAK,KAAK,SAAS,OAAO;AAC1D,aAAW;GACT,MAAM;GACN,YAAY;GACZ,WAAW;GACX,OAAO,EAAE;GACV;AACD,UAAQ,KAAK;YACJ,YAAY,MAAM;AAC3B,UAAQ,MAAM,wDAAwD;GACpE;GACA;GACA;GACD,CAAC;AACF;;CAEF,MAAM,QAAQ,SAAS,SAAS,EAAE;AAClC,UAAS,QAAQ;AACjB,KAAI,MAAM,WAAW,EACnB,OAAM,KAAK,KAAK;MAGb;EACH,IAAI,UAAU,KAAK,SAAS,QAAQ,KAAK,OAAO;EAChD,MAAMA,cAAgC,EAAE;EACxC,IAAI,SAAS;AACb,OAAK,MAAM,QAAQ,MACjB,KAAI,KAAK,SAAS,cAAc;AAC9B,OAAI,KAAK,SAAS,gBAAgB,KAAK,cAAc,KAAK,WAAW;AACnE,aAAS;AACT,SAAK,cAAc,iBACjB,KAAK,aACL,KAAK,YACN;;AAEH,eAAY,KAAK,KAAK;QAEtB,YAAW,KAAK;AAGpB,MAAI,KAAK,SAAS,gBAAgB,CAAC,OACjC,aAAY,KAAK,KAAK;EAExB,MAAMC,cAAsC,IAAI,MAAM,QAAQ,CAAC,KAAK,EAAE;AACtE,OAAK,MAAM,cAAc,aAAa;GACpC,MAAM,kBAAkB,WAAW,YAAY,SAAS;GACxD,MAAM,cAAc,YAAY;AAChC,OAAI,gBAAgB,KAAK,eAAe,KACtC,aAAY,OAAO,iBAAiB,GAAG,WAAW;OAIlD,aAAY,cAAc,iBACxB,YAAY,aACZ,WAAW,YACZ;;EAGL,MAAMC,WAAwB,EAAE;EAChC,IAAI,WAAW;AACf,OAAK,MAAM,QAAQ,YACjB,KAAI,SAAS,EACX;OACK;AACL,OAAI,WAAW,GAAG;AAChB,aAAS,KAAK;KAAE,MAAM;KAAO,MAAM;KAAU,CAAC;AAC9C,eAAW;;AAEb,YAAS,KAAK,KAAK;;AAGvB,MAAI,WAAW,EACb,UAAS,KAAK;GAAE,MAAM;GAAO,MAAM;GAAU,CAAC;AAEhD,WAAS,QAAQ;;;AAIrB,SAAS,iBAAiB,MAAgB,gBAAoC;AAC5E,KAAI,eAAe,WAAW,EAC5B,QAAO;CAET,MAAM,UAAU,IAAI,IAAI,KAAK;AAC7B,MAAK,MAAM,QAAQ,eACjB,SAAQ,IAAI,KAAK;AAEnB,QAAO,MAAM,KAAK,QAAQ"}