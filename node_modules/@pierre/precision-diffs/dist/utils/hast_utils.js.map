{"version":3,"file":"hast_utils.js","names":["contentChildren: ElementContent[]","firstChild: RootContent | Element | Root | null","properties: Properties","children: ElementContent[]"],"sources":["../../src/utils/hast_utils.ts"],"sourcesContent":["import type {\n  Element,\n  ElementContent,\n  Properties,\n  Root,\n  RootContent,\n  Text,\n} from 'hast';\n\nimport { DEFAULT_THEMES, HEADER_METADATA_SLOT_ID } from '../constants';\nimport type {\n  AnnotationSpan,\n  BaseDiffOptions,\n  ChangeTypes,\n  FileContents,\n  FileDiffMetadata,\n  HunkSeparators,\n  PJSHighlighter,\n  PJSThemeNames,\n  SharedRenderState,\n  ThemeTypes,\n  ThemesType,\n} from '../types';\nimport { getHighlighterThemeStyles } from './getHighlighterThemeStyles';\nimport { getIconForType } from './getIconForType';\n\nexport function createTextNode(value: string): Text {\n  return { type: 'text', value };\n}\n\ninterface CreateHastElementProps {\n  tagName:\n    | 'span'\n    | 'div'\n    | 'code'\n    | 'pre'\n    | 'slot'\n    | 'svg'\n    | 'use'\n    | 'style'\n    | 'template';\n  children?: ElementContent[];\n  properties?: Properties;\n}\n\nexport function createHastElement({\n  tagName,\n  children = [],\n  properties = {},\n}: CreateHastElementProps): Element {\n  return {\n    type: 'element',\n    tagName,\n    properties,\n    children,\n  };\n}\n\ninterface CreateSeparatorProps {\n  type: HunkSeparators;\n  content?: string;\n  expandIndex?: number;\n  slotName?: string;\n  isFirstHunk: boolean;\n  isLastHunk: boolean;\n}\n\nexport function createSeparator({\n  type,\n  content,\n  expandIndex,\n  slotName,\n  isFirstHunk,\n  isLastHunk,\n}: CreateSeparatorProps): Element {\n  const children = [];\n  if (type === 'metadata' && content != null) {\n    children.push(\n      createHastElement({\n        tagName: 'div',\n        children: [createTextNode(content)],\n        properties: { 'data-separator-content': '' },\n      })\n    );\n  }\n  if (type === 'line-info' && content != null) {\n    const contentChildren: ElementContent[] = [createTextNode(content)];\n    if (expandIndex != null) {\n      contentChildren.unshift(createIcon({ name: 'pjs-icon-chevrons-narrow' }));\n    }\n    children.push(\n      createHastElement({\n        tagName: 'div',\n        children: contentChildren,\n        properties: { 'data-separator-content': '' },\n      })\n    );\n  }\n  if (type === 'custom' && slotName != null) {\n    children.push(\n      createHastElement({\n        tagName: 'slot',\n        properties: { name: slotName },\n      })\n    );\n  }\n  return createHastElement({\n    tagName: 'div',\n    children,\n    properties: {\n      'data-separator': children.length === 0 ? '' : type,\n      'data-expand-index': expandIndex,\n      'data-separator-first': isFirstHunk ? '' : undefined,\n      'data-separator-last': isLastHunk ? '' : undefined,\n    },\n  });\n}\n\ninterface CreateIconProps {\n  name: string;\n  width?: number;\n  height?: number;\n  properties?: Properties;\n}\n\nexport function createIcon({\n  name,\n  width = 16,\n  height = 16,\n  properties,\n}: CreateIconProps): Element {\n  return createHastElement({\n    tagName: 'svg',\n    properties: { width, height, viewBox: '0 0 16 16', ...properties },\n    children: [\n      createHastElement({\n        tagName: 'use',\n        properties: { href: `#${name.replace(/^#/, '')}` },\n      }),\n    ],\n  });\n}\n\nexport function createAnnotationElement(span: AnnotationSpan): Element {\n  return createHastElement({\n    tagName: 'div',\n    children: [\n      createHastElement({\n        tagName: 'div',\n        children: span.annotations?.map((slotId) =>\n          createHastElement({ tagName: 'slot', properties: { name: slotId } })\n        ),\n        properties: { 'data-annotation-content': '' },\n      }),\n    ],\n    properties: {\n      'data-line-annotation': `${span.hunkIndex},${span.lineIndex}`,\n    },\n  });\n}\n\nexport function createEmptyRowBuffer(size: number): Element {\n  return createHastElement({\n    tagName: 'div',\n    properties: {\n      'data-buffer': '',\n      style: `grid-row: span ${size};min-height:calc(${size} * 1lh)`,\n    },\n  });\n}\n\nexport function findCodeElement(nodes: Root | Element): Element | undefined {\n  let firstChild: RootContent | Element | Root | null = nodes.children[0];\n  while (firstChild != null) {\n    if (firstChild.type === 'element' && firstChild.tagName === 'code') {\n      return firstChild;\n    }\n    if ('children' in firstChild) {\n      firstChild = firstChild.children[0];\n    } else {\n      firstChild = null;\n    }\n  }\n  return undefined;\n}\n\nexport function convertLine(\n  node: Element,\n  line: number,\n  state: SharedRenderState\n): ElementContent {\n  const lineInfo = state.lineInfo[line];\n  if (lineInfo == null) {\n    console.error({ node, line, state });\n    throw new Error(`convertLine: line ${line}, contains no state.lineInfo`);\n  }\n  // We need to convert the current line to a div but keep all the decorations\n  // that may be applied\n  node.tagName = 'span';\n  node.properties['data-column-content'] = '';\n  if (lineInfo.metadataContent != null) {\n    node.children.push(\n      createHastElement({\n        tagName: 'span',\n        children: [createTextNode(lineInfo.metadataContent)],\n        properties: { 'data-no-newline': '' },\n      })\n    );\n  }\n  // NOTE(amadeus): We need to push newline characters into empty rows or else\n  // copy/pasta will have issues\n  else if (node.children.length === 0) {\n    node.children.push(createTextNode('\\n'));\n  }\n  const children = [node];\n  if (!state.disableLineNumbers) {\n    children.unshift(\n      createHastElement({\n        tagName: 'span',\n        children:\n          lineInfo.metadataContent == null\n            ? [{ type: 'text', value: `${lineInfo.lineNumber}` }]\n            : [],\n        properties: { 'data-column-number': '' },\n      })\n    );\n  }\n  return createHastElement({\n    tagName: 'div',\n    children,\n    properties: {\n      'data-line':\n        lineInfo.metadataContent == null ? `${lineInfo.lineNumber}` : '',\n      'data-line-type': lineInfo.type,\n    },\n  });\n}\n\ninterface CreatePreWrapperPropertiesProps\n  extends Pick<\n    BaseDiffOptions,\n    'overflow' | 'themeType' | 'diffIndicators' | 'disableBackground' | 'theme'\n  > {\n  split: boolean;\n  highlighter: PJSHighlighter;\n  totalLines: number;\n}\n\nexport function createPreWrapperProperties({\n  diffIndicators = 'bars',\n  disableBackground = false,\n  highlighter,\n  overflow = 'scroll',\n  split,\n  theme = DEFAULT_THEMES,\n  themeType = 'system',\n  totalLines,\n}: CreatePreWrapperPropertiesProps): Properties {\n  const properties: Properties = {\n    'data-pjs': '',\n    'data-type': split ? 'split' : 'file',\n    'data-overflow': overflow,\n    // NOTE(amadeus): Alex, here we would probably set a class property\n    // instead, when that's working and supported\n    style: getHighlighterThemeStyles({ theme, highlighter }),\n    tabIndex: 0,\n  };\n  properties.style += `--pjs-min-number-column-width-default:${`${totalLines}`.length}ch;`;\n\n  if (typeof theme === 'string' && themeType !== 'system') {\n    properties['data-theme-type'] = themeType;\n  } else if (typeof theme === 'string') {\n    const themeData = highlighter.getTheme(theme);\n    properties['data-theme-type'] = themeData.type;\n  }\n\n  switch (diffIndicators) {\n    case 'bars':\n    case 'classic':\n      properties['data-indicators'] = diffIndicators;\n      break;\n  }\n\n  if (!disableBackground) {\n    properties['data-background'] = '';\n  }\n\n  return properties;\n}\n\ninterface CreateFileHeaderProps {\n  fileOrDiff: FileDiffMetadata | FileContents;\n  theme?: PJSThemeNames | ThemesType;\n  highlighter: PJSHighlighter;\n  prefix?: string;\n  themeType?: ThemeTypes;\n}\n\nexport function createFileHeaderElement({\n  fileOrDiff,\n  theme,\n  highlighter,\n  prefix,\n  themeType = 'system',\n}: CreateFileHeaderProps): Element {\n  const fileDiff = 'type' in fileOrDiff ? fileOrDiff : undefined;\n  const properties: Properties = {\n    'data-pjs-header': '',\n    style: getHighlighterThemeStyles({ theme, highlighter, prefix }),\n  };\n\n  if (fileDiff != null) {\n    properties['data-change-type'] = fileDiff.type;\n  }\n\n  // If a theme is specified, then we should just override the themeType and\n  // ignore whatever might be passed in\n  if (typeof theme === 'string') {\n    const themeData = highlighter.getTheme(theme);\n    properties['data-theme-type'] = themeData.type;\n  } else if (themeType !== 'system') {\n    properties['data-theme-type'] = themeType;\n  }\n\n  return createHastElement({\n    tagName: 'div',\n    children: [\n      createHeaderElement({\n        name: fileOrDiff.name,\n        prevName: 'prevName' in fileOrDiff ? fileOrDiff.prevName : undefined,\n        iconType: fileDiff?.type ?? 'file',\n      }),\n      createMetadataElement(fileDiff),\n    ],\n    properties,\n  });\n}\n\ninterface CreateHeaderElementOptions {\n  name: string;\n  prevName?: string;\n  iconType: ChangeTypes | 'file';\n}\n\nfunction createHeaderElement({\n  name,\n  prevName,\n  iconType,\n}: CreateHeaderElementOptions): Element {\n  const children: ElementContent[] = [\n    createIcon({\n      name: getIconForType(iconType),\n      properties: { 'data-change-icon': iconType },\n    }),\n  ];\n  if (prevName != null) {\n    children.push(\n      createHastElement({\n        tagName: 'div',\n        children: [createTextNode(prevName)],\n        properties: {\n          'data-prev-name': '',\n        },\n      })\n    );\n    children.push(\n      createIcon({\n        name: 'pjs-icon-arrow',\n        properties: {\n          'data-rename-icon': '',\n        },\n      })\n    );\n  }\n  children.push(\n    createHastElement({\n      tagName: 'div',\n      children: [createTextNode(name)],\n      properties: { 'data-title': '' },\n    })\n  );\n  return createHastElement({\n    tagName: 'div',\n    children,\n    properties: { 'data-header-content': '' },\n  });\n}\n\nfunction createMetadataElement(\n  fileDiff: FileDiffMetadata | undefined\n): Element {\n  const children: ElementContent[] = [];\n  if (fileDiff != null) {\n    let additions = 0;\n    let deletions = 0;\n    for (const hunk of fileDiff.hunks) {\n      for (const line of hunk.hunkContent ?? []) {\n        if (line.startsWith('+')) {\n          additions++;\n        } else if (line.startsWith('-')) {\n          deletions++;\n        }\n      }\n    }\n    if (deletions > 0) {\n      children.push(\n        createHastElement({\n          tagName: 'span',\n          children: [createTextNode(`-${deletions}`)],\n          properties: { 'data-deletions-count': '' },\n        })\n      );\n    }\n    if (additions > 0) {\n      children.push(\n        createHastElement({\n          tagName: 'span',\n          children: [createTextNode(`+${additions}`)],\n          properties: { 'data-additions-count': '' },\n        })\n      );\n    }\n    if (deletions === 0 && additions === 0) {\n      children.push(\n        createHastElement({\n          tagName: 'span',\n          children: [createTextNode('No diff')],\n        })\n      );\n    }\n  }\n  children.push(\n    createHastElement({\n      tagName: 'slot',\n      properties: { name: HEADER_METADATA_SLOT_ID },\n    })\n  );\n  return createHastElement({\n    tagName: 'div',\n    children,\n    properties: { 'data-metadata': '' },\n  });\n}\n"],"mappings":"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"}