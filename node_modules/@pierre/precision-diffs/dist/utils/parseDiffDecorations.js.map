{"version":3,"file":"parseDiffDecorations.js","names":["unifiedDecorations: DecorationItem[]","additionDecorations: DecorationItem[]","deletionDecorations: DecorationItem[]","deletionSpans: [0 | 1, string][]","additionSpans: [0 | 1, string][]"],"sources":["../../src/utils/parseDiffDecorations.ts"],"sourcesContent":["import { type ChangeObject, diffChars, diffWordsWithSpace } from 'diff';\n\nimport type { ChangeHunk, DecorationItem, LineDifftypes } from '../types';\n\ninterface ParseDecorationsProps {\n  diffGroups: ChangeHunk[];\n  disableDecorations?: boolean;\n  lineDiffType: LineDifftypes;\n  maxLineDiffLength: number;\n  diffStyle: 'unified' | 'split';\n}\n\ninterface ParseDecorationsReturn {\n  unifiedDecorations: DecorationItem[];\n  deletionDecorations: DecorationItem[];\n  additionDecorations: DecorationItem[];\n}\n\nexport function parseDecorations({\n  diffGroups,\n  disableDecorations = false,\n  lineDiffType,\n  maxLineDiffLength,\n  diffStyle,\n}: ParseDecorationsProps): ParseDecorationsReturn {\n  const unified = diffStyle === 'unified';\n  const unifiedDecorations: DecorationItem[] = [];\n  const additionDecorations: DecorationItem[] = [];\n  const deletionDecorations: DecorationItem[] = [];\n  if (disableDecorations || lineDiffType === 'none') {\n    return { unifiedDecorations, deletionDecorations, additionDecorations };\n  }\n  for (const group of diffGroups) {\n    const len = Math.min(\n      group.additionLines.length,\n      group.deletionLines.length\n    );\n    for (let i = 0; i < len; i++) {\n      const deletionLine = group.deletionLines[i];\n      const additionLine = group.additionLines[i];\n      if (deletionLine == null || additionLine == null) {\n        break;\n      }\n      // Lets skep running diffs on super long lines because it's probably\n      // expensive and hard to follow\n      if (\n        deletionLine.length > maxLineDiffLength ||\n        additionLine.length > maxLineDiffLength\n      ) {\n        continue;\n      }\n      const lineDiff =\n        lineDiffType === 'char'\n          ? diffChars(deletionLine, additionLine)\n          : diffWordsWithSpace(deletionLine, additionLine);\n      const deletionSpans: [0 | 1, string][] = [];\n      const additionSpans: [0 | 1, string][] = [];\n      const enableJoin = lineDiffType === 'word-alt';\n      for (const item of lineDiff) {\n        if (!item.added && !item.removed) {\n          pushOrJoinSpan({\n            item,\n            arr: deletionSpans,\n            enableJoin,\n            isNeutral: true,\n          });\n          pushOrJoinSpan({\n            item,\n            arr: additionSpans,\n            enableJoin,\n            isNeutral: true,\n          });\n        } else if (item.removed) {\n          pushOrJoinSpan({ item, arr: deletionSpans, enableJoin });\n        } else {\n          pushOrJoinSpan({ item, arr: additionSpans, enableJoin });\n        }\n      }\n      let spanIndex = 0;\n      for (const span of additionSpans) {\n        if (span[0] === 1) {\n          (unified ? unifiedDecorations : additionDecorations).push(\n            createDiffSpanDecoration({\n              line: group.additionStartIndex + i,\n              spanStart: spanIndex,\n              spanLength: span[1].length,\n            })\n          );\n        }\n        spanIndex += span[1].length;\n      }\n      spanIndex = 0;\n      for (const span of deletionSpans) {\n        if (span[0] === 1) {\n          (unified ? unifiedDecorations : deletionDecorations).push(\n            createDiffSpanDecoration({\n              line: group.deletionStartIndex + i,\n              spanStart: spanIndex,\n              spanLength: span[1].length,\n            })\n          );\n        }\n        spanIndex += span[1].length;\n      }\n    }\n  }\n  return { unifiedDecorations, deletionDecorations, additionDecorations };\n}\n\ninterface CreateDiffSpanDecorationProps {\n  line: number;\n  spanStart: number;\n  spanLength: number;\n}\n\nfunction createDiffSpanDecoration({\n  line,\n  spanStart,\n  spanLength,\n}: CreateDiffSpanDecorationProps): DecorationItem {\n  return {\n    start: { line, character: spanStart },\n    end: { line, character: spanStart + spanLength },\n    properties: { 'data-diff-span': '' },\n    alwaysWrap: true,\n  };\n}\n\ninterface PushOrJoinSpanProps {\n  item: ChangeObject<string>;\n  arr: [0 | 1, string][];\n  enableJoin: boolean;\n  isNeutral?: boolean;\n}\n\n// For diff decoration spans, we want to be sure that if there is a single\n// white-space gap between diffs that we join them together into a longer diff span.\n// Spans are basically just a tuple - 1 means the content should be\n// highlighted, 0 means it should not, we still need to the span data to figure\n// out span positions\nfunction pushOrJoinSpan({\n  item,\n  arr,\n  enableJoin,\n  isNeutral = false,\n}: PushOrJoinSpanProps) {\n  const lastItem = arr[arr.length - 1];\n  if (lastItem == null || item.value === '\\n' || !enableJoin) {\n    arr.push([isNeutral ? 0 : 1, item.value]);\n    return;\n  }\n  const isLastItemNeutral = lastItem[0] === 0;\n  if (\n    isNeutral === isLastItemNeutral ||\n    // If we have a single space neutral item, lets join it to a previously\n    // space non-neutral item to avoid single space gaps\n    (isNeutral && item.value.length === 1 && !isLastItemNeutral)\n  ) {\n    lastItem[1] += item.value;\n    return;\n  }\n  arr.push([isNeutral ? 0 : 1, item.value]);\n}\n"],"mappings":";;;AAkBA,SAAgB,iBAAiB,EAC/B,YACA,qBAAqB,OACrB,cACA,mBACA,aACgD;CAChD,MAAM,UAAU,cAAc;CAC9B,MAAMA,qBAAuC,EAAE;CAC/C,MAAMC,sBAAwC,EAAE;CAChD,MAAMC,sBAAwC,EAAE;AAChD,KAAI,sBAAsB,iBAAiB,OACzC,QAAO;EAAE;EAAoB;EAAqB;EAAqB;AAEzE,MAAK,MAAM,SAAS,YAAY;EAC9B,MAAM,MAAM,KAAK,IACf,MAAM,cAAc,QACpB,MAAM,cAAc,OACrB;AACD,OAAK,IAAI,IAAI,GAAG,IAAI,KAAK,KAAK;GAC5B,MAAM,eAAe,MAAM,cAAc;GACzC,MAAM,eAAe,MAAM,cAAc;AACzC,OAAI,gBAAgB,QAAQ,gBAAgB,KAC1C;AAIF,OACE,aAAa,SAAS,qBACtB,aAAa,SAAS,kBAEtB;GAEF,MAAM,WACJ,iBAAiB,SACb,UAAU,cAAc,aAAa,GACrC,mBAAmB,cAAc,aAAa;GACpD,MAAMC,gBAAmC,EAAE;GAC3C,MAAMC,gBAAmC,EAAE;GAC3C,MAAM,aAAa,iBAAiB;AACpC,QAAK,MAAM,QAAQ,SACjB,KAAI,CAAC,KAAK,SAAS,CAAC,KAAK,SAAS;AAChC,mBAAe;KACb;KACA,KAAK;KACL;KACA,WAAW;KACZ,CAAC;AACF,mBAAe;KACb;KACA,KAAK;KACL;KACA,WAAW;KACZ,CAAC;cACO,KAAK,QACd,gBAAe;IAAE;IAAM,KAAK;IAAe;IAAY,CAAC;OAExD,gBAAe;IAAE;IAAM,KAAK;IAAe;IAAY,CAAC;GAG5D,IAAI,YAAY;AAChB,QAAK,MAAM,QAAQ,eAAe;AAChC,QAAI,KAAK,OAAO,EACd,EAAC,UAAU,qBAAqB,qBAAqB,KACnD,yBAAyB;KACvB,MAAM,MAAM,qBAAqB;KACjC,WAAW;KACX,YAAY,KAAK,GAAG;KACrB,CAAC,CACH;AAEH,iBAAa,KAAK,GAAG;;AAEvB,eAAY;AACZ,QAAK,MAAM,QAAQ,eAAe;AAChC,QAAI,KAAK,OAAO,EACd,EAAC,UAAU,qBAAqB,qBAAqB,KACnD,yBAAyB;KACvB,MAAM,MAAM,qBAAqB;KACjC,WAAW;KACX,YAAY,KAAK,GAAG;KACrB,CAAC,CACH;AAEH,iBAAa,KAAK,GAAG;;;;AAI3B,QAAO;EAAE;EAAoB;EAAqB;EAAqB;;AASzE,SAAS,yBAAyB,EAChC,MACA,WACA,cACgD;AAChD,QAAO;EACL,OAAO;GAAE;GAAM,WAAW;GAAW;EACrC,KAAK;GAAE;GAAM,WAAW,YAAY;GAAY;EAChD,YAAY,EAAE,kBAAkB,IAAI;EACpC,YAAY;EACb;;AAeH,SAAS,eAAe,EACtB,MACA,KACA,YACA,YAAY,SACU;CACtB,MAAM,WAAW,IAAI,IAAI,SAAS;AAClC,KAAI,YAAY,QAAQ,KAAK,UAAU,QAAQ,CAAC,YAAY;AAC1D,MAAI,KAAK,CAAC,YAAY,IAAI,GAAG,KAAK,MAAM,CAAC;AACzC;;CAEF,MAAM,oBAAoB,SAAS,OAAO;AAC1C,KACE,cAAc,qBAGb,aAAa,KAAK,MAAM,WAAW,KAAK,CAAC,mBAC1C;AACA,WAAS,MAAM,KAAK;AACpB;;AAEF,KAAI,KAAK,CAAC,YAAY,IAAI,GAAG,KAAK,MAAM,CAAC"}