{"version":3,"file":"FileDiffServer.js","names":["rawStyles"],"sources":["../../src/ssr/FileDiffServer.ts"],"sourcesContent":["import { toHtml } from 'hast-util-to-html';\n\nimport type { FileOptions } from '../../src/File';\nimport type { FileDiffOptions } from '../../src/FileDiff';\nimport { DiffHunksRenderer } from '../DiffHunksRenderer';\nimport { FileHeaderRenderer } from '../FileHeaderRenderer';\nimport { FileRenderer } from '../FileRenderer';\nimport { SVGSpriteSheet } from '../sprite';\nimport rawStyles from '../style.css';\nimport type {\n  DiffLineAnnotation,\n  FileContents,\n  LineAnnotation,\n} from '../types';\nimport { createHastElement, createTextNode } from '../utils/hast_utils';\nimport { parseDiffFromFile } from '../utils/parseDiffFromFile';\n\nexport type PreloadFileOptions<LAnnotation> = {\n  file: FileContents;\n  options?: FileOptions<LAnnotation>;\n  annotations?: LineAnnotation<LAnnotation>[];\n};\n\nexport interface PreloadedFileResult<LAnnotation> {\n  file: FileContents;\n  options?: FileOptions<LAnnotation>;\n  annotations?: LineAnnotation<LAnnotation>[];\n  prerenderedHTML: string;\n}\n\nexport type PreloadFileDiffOptions<LAnnotation> = {\n  oldFile: FileContents;\n  newFile: FileContents;\n  options?: FileDiffOptions<LAnnotation>;\n  annotations?: DiffLineAnnotation<LAnnotation>[];\n};\n\nexport interface PreloadedFileDiffResult<LAnnotation> {\n  oldFile: FileContents;\n  newFile: FileContents;\n  options?: FileDiffOptions<LAnnotation>;\n  annotations?: DiffLineAnnotation<LAnnotation>[];\n  prerenderedHTML: string;\n}\n\nexport async function preloadFile<LAnnotation = undefined>({\n  file,\n  options,\n  annotations,\n}: PreloadFileOptions<LAnnotation>): Promise<PreloadedFileResult<LAnnotation>> {\n  const fileRenderer = new FileRenderer<LAnnotation>(options);\n  const fileHeader = new FileHeaderRenderer(options);\n\n  // Set line annotations if provided\n  if (annotations !== undefined && annotations.length > 0) {\n    fileRenderer.setLineAnnotations(annotations);\n  }\n\n  const [fileResult, headerResult] = await Promise.all([\n    fileRenderer.render(file, true),\n    fileHeader.render(file),\n  ]);\n  if (fileResult == null) {\n    throw new Error('Failed to render file diff');\n  }\n  const cssText = `@layer base, theme, unsafe;\n    @layer base {\n      ${rawStyles}\n    }\n    @layer theme {\n      ${fileResult.css}\n    }\n    @layer unsafe {\n      ${options?.unsafeCSS ?? ''}\n    }`;\n\n  const children = [\n    createHastElement({\n      tagName: 'style',\n      children: [createTextNode(cssText)],\n    }),\n  ];\n  if (headerResult != null) {\n    children.push(headerResult);\n  }\n  const code = fileRenderer.renderFullAST(fileResult);\n  code.properties['data-dehydrated'] = '';\n  children.push(code);\n\n  return {\n    file,\n    options,\n    annotations,\n    prerenderedHTML: `${SVGSpriteSheet}${toHtml(children)}`,\n  };\n}\n\nexport async function preloadFileDiff<LAnnotation = undefined>({\n  oldFile,\n  newFile,\n  options,\n  annotations,\n}: PreloadFileDiffOptions<LAnnotation>): Promise<\n  PreloadedFileDiffResult<LAnnotation>\n> {\n  const fileDiff = parseDiffFromFile(oldFile, newFile);\n  const diffHunksRenderer = new DiffHunksRenderer<LAnnotation>({\n    ...options,\n    hunkSeparators:\n      typeof options?.hunkSeparators === 'function'\n        ? 'custom'\n        : options?.hunkSeparators,\n    useCSSClasses: true,\n  });\n  const fileHeader = new FileHeaderRenderer(options);\n\n  // Set line annotations if provided\n  if (annotations !== undefined && annotations.length > 0) {\n    diffHunksRenderer.setLineAnnotations(annotations);\n  }\n\n  const [hunkResult, headerResult] = await Promise.all([\n    diffHunksRenderer.render(fileDiff),\n    fileHeader.render(fileDiff),\n  ]);\n  if (hunkResult == null) {\n    throw new Error('Failed to render file diff');\n  }\n  const cssText = `@layer base, theme, unsafe;\n    @layer base {\n      ${rawStyles}\n    }\n    @layer theme {\n      ${hunkResult.css}\n    }\n    @layer unsafe {\n      ${options?.unsafeCSS ?? ''}\n    }`;\n\n  const children = [\n    createHastElement({\n      tagName: 'style',\n      children: [createTextNode(cssText)],\n    }),\n  ];\n  if (headerResult != null) {\n    children.push(headerResult);\n  }\n  const code = diffHunksRenderer.renderFullAST(hunkResult);\n  code.properties['data-dehydrated'] = '';\n  children.push(code);\n\n  return {\n    oldFile,\n    newFile,\n    options,\n    annotations,\n    prerenderedHTML: `${SVGSpriteSheet}${toHtml(children)}`,\n  };\n}\n"],"mappings":";;;;;;;;;;AA6CA,eAAsB,YAAqC,EACzD,MACA,SACA,eAC6E;CAC7E,MAAM,eAAe,IAAI,aAA0B,QAAQ;CAC3D,MAAM,aAAa,IAAI,mBAAmB,QAAQ;AAGlD,KAAI,gBAAgB,UAAa,YAAY,SAAS,EACpD,cAAa,mBAAmB,YAAY;CAG9C,MAAM,CAAC,YAAY,gBAAgB,MAAM,QAAQ,IAAI,CACnD,aAAa,OAAO,MAAM,KAAK,EAC/B,WAAW,OAAO,KAAK,CACxB,CAAC;AACF,KAAI,cAAc,KAChB,OAAM,IAAI,MAAM,6BAA6B;CAa/C,MAAM,WAAW,CACf,kBAAkB;EAChB,SAAS;EACT,UAAU,CAAC,eAdC;;QAEVA,cAAU;;;QAGV,WAAW,IAAI;;;QAGf,SAAS,aAAa,GAAG;OAMO,CAAC;EACpC,CAAC,CACH;AACD,KAAI,gBAAgB,KAClB,UAAS,KAAK,aAAa;CAE7B,MAAM,OAAO,aAAa,cAAc,WAAW;AACnD,MAAK,WAAW,qBAAqB;AACrC,UAAS,KAAK,KAAK;AAEnB,QAAO;EACL;EACA;EACA;EACA,iBAAiB,GAAG,iBAAiB,OAAO,SAAS;EACtD;;AAGH,eAAsB,gBAAyC,EAC7D,SACA,SACA,SACA,eAGA;CACA,MAAM,WAAW,kBAAkB,SAAS,QAAQ;CACpD,MAAM,oBAAoB,IAAI,kBAA+B;EAC3D,GAAG;EACH,gBACE,OAAO,SAAS,mBAAmB,aAC/B,WACA,SAAS;EACf,eAAe;EAChB,CAAC;CACF,MAAM,aAAa,IAAI,mBAAmB,QAAQ;AAGlD,KAAI,gBAAgB,UAAa,YAAY,SAAS,EACpD,mBAAkB,mBAAmB,YAAY;CAGnD,MAAM,CAAC,YAAY,gBAAgB,MAAM,QAAQ,IAAI,CACnD,kBAAkB,OAAO,SAAS,EAClC,WAAW,OAAO,SAAS,CAC5B,CAAC;AACF,KAAI,cAAc,KAChB,OAAM,IAAI,MAAM,6BAA6B;CAa/C,MAAM,WAAW,CACf,kBAAkB;EAChB,SAAS;EACT,UAAU,CAAC,eAdC;;QAEVA,cAAU;;;QAGV,WAAW,IAAI;;;QAGf,SAAS,aAAa,GAAG;OAMO,CAAC;EACpC,CAAC,CACH;AACD,KAAI,gBAAgB,KAClB,UAAS,KAAK,aAAa;CAE7B,MAAM,OAAO,kBAAkB,cAAc,WAAW;AACxD,MAAK,WAAW,qBAAqB;AACrC,UAAS,KAAK,KAAK;AAEnB,QAAO;EACL;EACA;EACA;EACA;EACA,iBAAiB,GAAG,iBAAiB,OAAO,SAAS;EACtD"}