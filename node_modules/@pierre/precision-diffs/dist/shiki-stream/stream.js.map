{"version":3,"file":"stream.js","names":[],"sources":["../../src/shiki-stream/stream.ts"],"sourcesContent":["import type { ThemedToken } from '@shikijs/core';\n\nimport { ShikiStreamTokenizer } from './tokenizer';\nimport type { CodeToTokenTransformStreamOptions, RecallToken } from './types';\n\n/**\n * Create a transform stream that takes code chunks and emits themed tokens.\n */\nexport class CodeToTokenTransformStream extends TransformStream<\n  string,\n  ThemedToken | RecallToken\n> {\n  readonly tokenizer: ShikiStreamTokenizer;\n  readonly options: CodeToTokenTransformStreamOptions;\n\n  constructor(options: CodeToTokenTransformStreamOptions) {\n    const tokenizer = new ShikiStreamTokenizer(options);\n    const { allowRecalls = false } = options;\n\n    super({\n      async transform(chunk, controller) {\n        const {\n          stable,\n          unstable: buffer,\n          recall,\n        } = await tokenizer.enqueue(chunk);\n        if (allowRecalls && recall > 0) {\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          controller.enqueue({ recall } as any);\n        }\n        for (const token of stable) {\n          controller.enqueue(token);\n        }\n        if (allowRecalls) {\n          for (const token of buffer) {\n            controller.enqueue(token);\n          }\n        }\n      },\n      // eslint-disable-next-line @typescript-eslint/require-await\n      async flush(controller) {\n        const { stable } = tokenizer.close();\n        // if allow recalls, the tokens should already be sent\n        if (!allowRecalls) {\n          for (const token of stable) {\n            controller.enqueue(token);\n          }\n        }\n      },\n    });\n\n    this.tokenizer = tokenizer;\n    this.options = options;\n  }\n}\n"],"mappings":";;;;;;AAQA,IAAa,6BAAb,cAAgD,gBAG9C;CACA,AAAS;CACT,AAAS;CAET,YAAY,SAA4C;EACtD,MAAM,YAAY,IAAI,qBAAqB,QAAQ;EACnD,MAAM,EAAE,eAAe,UAAU;AAEjC,QAAM;GACJ,MAAM,UAAU,OAAO,YAAY;IACjC,MAAM,EACJ,QACA,UAAU,QACV,WACE,MAAM,UAAU,QAAQ,MAAM;AAClC,QAAI,gBAAgB,SAAS,EAE3B,YAAW,QAAQ,EAAE,QAAQ,CAAQ;AAEvC,SAAK,MAAM,SAAS,OAClB,YAAW,QAAQ,MAAM;AAE3B,QAAI,aACF,MAAK,MAAM,SAAS,OAClB,YAAW,QAAQ,MAAM;;GAK/B,MAAM,MAAM,YAAY;IACtB,MAAM,EAAE,WAAW,UAAU,OAAO;AAEpC,QAAI,CAAC,aACH,MAAK,MAAM,SAAS,OAClB,YAAW,QAAQ,MAAM;;GAIhC,CAAC;AAEF,OAAK,YAAY;AACjB,OAAK,UAAU"}