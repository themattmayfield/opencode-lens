{"version":3,"file":"ResizeManager.js","names":["item: ObservedGridNodes","item: ObservedAnnotationNodes"],"sources":["../src/ResizeManager.ts"],"sourcesContent":["import type { ObservedAnnotationNodes, ObservedGridNodes } from './types';\n\nexport class ResizeManager {\n  private observedNodes = new Map<\n    HTMLElement,\n    ObservedAnnotationNodes | ObservedGridNodes\n  >();\n\n  cleanUp(): void {\n    // Disconnect any existing observer\n    this.resizeObserver?.disconnect();\n    this.observedNodes.clear();\n  }\n\n  private resizeObserver: ResizeObserver | undefined;\n\n  setup(pre: HTMLPreElement): void {\n    this.cleanUp();\n\n    const annotationElements = pre.querySelectorAll(\n      '[data-line-annotation*=\",\"]'\n    );\n\n    this.resizeObserver ??= new ResizeObserver(this.handleResizeObserver);\n    const codeElements = pre.querySelectorAll('code');\n\n    for (const codeElement of codeElements) {\n      let numberElement = codeElement.querySelector('[data-column-number]');\n      if (!(numberElement instanceof HTMLElement)) {\n        numberElement = null;\n      }\n      const item: ObservedGridNodes = {\n        type: 'code',\n        codeElement,\n        numberElement,\n        codeWidth: 'auto',\n        numberWidth: 0,\n      };\n      this.observedNodes.set(codeElement, item);\n      this.resizeObserver.observe(codeElement);\n      if (numberElement != null) {\n        this.observedNodes.set(numberElement, item);\n        this.resizeObserver.observe(numberElement);\n      }\n    }\n\n    if (codeElements.length <= 1) {\n      return;\n    }\n\n    const elementMap = new Map<string, HTMLElement[]>();\n    for (const element of annotationElements) {\n      if (!(element instanceof HTMLElement)) {\n        continue;\n      }\n      const { lineAnnotation = '' } = element.dataset;\n      if (!/^\\d+,\\d+$/.test(lineAnnotation)) {\n        console.error(\n          'DiffFileRenderer.setupResizeObserver: Invalid element or annotation',\n          { lineAnnotation, element }\n        );\n        continue;\n      }\n      let pairs = elementMap.get(lineAnnotation);\n      if (pairs == null) {\n        pairs = [];\n        elementMap.set(lineAnnotation, pairs);\n      }\n      pairs.push(element);\n    }\n\n    for (const [key, pair] of elementMap) {\n      if (pair.length !== 2) {\n        console.error(\n          'DiffFileRenderer.setupResizeObserver: Bad Pair',\n          key,\n          pair\n        );\n        continue;\n      }\n      const [container1, container2] = pair;\n      const child1 = container1.firstElementChild;\n      const child2 = container2.firstElementChild;\n      if (\n        !(container1 instanceof HTMLElement) ||\n        !(container2 instanceof HTMLElement) ||\n        !(child1 instanceof HTMLElement) ||\n        !(child2 instanceof HTMLElement)\n      ) {\n        continue;\n      }\n      const item: ObservedAnnotationNodes = {\n        type: 'annotations',\n        column1: {\n          container: container1,\n          child: child1,\n          childHeight: 0,\n        },\n        column2: {\n          container: container2,\n          child: child2,\n          childHeight: 0,\n        },\n        currentHeight: 'auto',\n      };\n      this.observedNodes.set(child1, item);\n      this.observedNodes.set(child2, item);\n      this.resizeObserver.observe(child1);\n      this.resizeObserver.observe(child2);\n    }\n  }\n\n  private handleResizeObserver = (entries: ResizeObserverEntry[]) => {\n    for (const entry of entries) {\n      const { target, borderBoxSize } = entry;\n      if (!(target instanceof HTMLElement)) {\n        console.error(\n          'FileDiff.handleResizeObserver: Invalid element for ResizeObserver',\n          entry\n        );\n        continue;\n      }\n      const item = this.observedNodes.get(target);\n      if (item == null) {\n        console.error(\n          'FileDiff.handleResizeObserver: Not a valid observed node',\n          entry\n        );\n        continue;\n      }\n      const specs = borderBoxSize[0];\n      if (item.type === 'annotations') {\n        const column = (() => {\n          if (target === item.column1.child) {\n            return item.column1;\n          }\n          if (target === item.column2.child) {\n            return item.column2;\n          }\n          return undefined;\n        })();\n\n        if (column == null) {\n          console.error(\n            `FileDiff.handleResizeObserver: Couldn't find a column for`,\n            { item, target }\n          );\n          continue;\n        }\n\n        column.childHeight = specs.blockSize;\n        const newHeight = Math.max(\n          item.column1.childHeight,\n          item.column2.childHeight\n        );\n        if (newHeight !== item.currentHeight) {\n          item.currentHeight = Math.max(newHeight, 0);\n          item.column1.container.style.setProperty(\n            '--pjs-annotation-min-height',\n            `${item.currentHeight}px`\n          );\n          item.column2.container.style.setProperty(\n            '--pjs-annotation-min-height',\n            `${item.currentHeight}px`\n          );\n        }\n      } else if (item.type === 'code') {\n        if (target === item.codeElement) {\n          if (specs.inlineSize !== item.codeWidth) {\n            item.codeWidth = specs.inlineSize;\n            item.codeElement.style.setProperty(\n              '--pjs-column-content-width',\n              `${Math.max(item.codeWidth - item.numberWidth, 0)}px`\n            );\n            item.codeElement.style.setProperty(\n              '--pjs-column-width',\n              `${item.codeWidth}px`\n            );\n          }\n        } else if (target === item.numberElement) {\n          if (specs.inlineSize !== item.numberWidth) {\n            item.numberWidth = specs.inlineSize;\n            item.codeElement.style.setProperty(\n              '--pjs-column-number-width',\n              `${item.numberWidth}px`\n            );\n            // We probably need to update code width variable if\n            // `numberWidth` changed\n            if (item.codeWidth !== 'auto') {\n              item.codeElement.style.setProperty(\n                '--pjs-column-content-width',\n                `${Math.max(item.codeWidth - item.numberWidth, 0)}px`\n              );\n            }\n          }\n        }\n      }\n    }\n  };\n}\n"],"mappings":"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"}