{"version":3,"file":"SharedHighlighter.js","names":["highlighter: CachedOrLoadingHighlighterType","themesToLoad: (\n            | PJSThemeNames\n            | Promise<ThemeRegistrationResolved>\n          )[]","instance","loaders: Promise<void>[]"],"sources":["../src/SharedHighlighter.ts"],"sourcesContent":["import {\n  createHighlighter,\n  createJavaScriptRegexEngine,\n  createOnigurumaEngine,\n  loadWasm,\n} from 'shiki';\n\nimport type {\n  PJSHighlighter,\n  PJSThemeNames,\n  SupportedLanguages,\n  ThemeRegistrationResolved,\n} from './types';\n\ntype CachedOrLoadingHighlighterType =\n  | Promise<PJSHighlighter>\n  | PJSHighlighter\n  | undefined;\n\nlet highlighter: CachedOrLoadingHighlighterType;\n\nconst loadedThemes = new Map<string, true | Promise<void>>();\nconst loadedLanguages = new Map<SupportedLanguages, true | Promise<void>>();\n\ninterface HighlighterOptions {\n  themes: PJSThemeNames[];\n  langs: SupportedLanguages[];\n  preferWasmHighlighter?: boolean;\n}\n\nexport async function getSharedHighlighter({\n  themes,\n  langs,\n  preferWasmHighlighter = false,\n}: HighlighterOptions): Promise<PJSHighlighter> {\n  if (isHighlighterNull(highlighter)) {\n    // NOTE(amadeus): We should probably build in some logic for rejection\n    // handling...\n    highlighter = new Promise((resolve) => {\n      void (\n        preferWasmHighlighter\n          ? loadWasm(import('shiki/wasm'))\n          : Promise.resolve()\n      )\n        .then(() => {\n          // Since we are loading the languages and themes along with the\n          // highlighter, we can just go ahead and mark them as loaded since\n          // they'll be ready when the highlighter is ready which any calls to\n          // getSharedHighlighter will resolve automatically for us\n          const themesToLoad: (\n            | PJSThemeNames\n            | Promise<ThemeRegistrationResolved>\n          )[] = [];\n          for (const theme of themes) {\n            loadedThemes.set(theme, true);\n            const customTheme = CustomThemes.get(theme);\n            if (customTheme != null) {\n              themesToLoad.push(customTheme());\n            } else {\n              themesToLoad.push(theme);\n            }\n          }\n          for (const language of langs) {\n            loadedLanguages.set(language, true);\n          }\n          loadedLanguages.set('text', true);\n          return createHighlighter({\n            themes: themesToLoad,\n            langs: [...langs, 'text'],\n            engine: preferWasmHighlighter\n              ? createOnigurumaEngine()\n              : createJavaScriptRegexEngine(),\n          }) as Promise<PJSHighlighter>;\n        })\n        .then((instance) => {\n          highlighter = instance;\n          resolve(instance);\n        });\n    });\n    return highlighter;\n  }\n  const instance = isHighlighterLoading(highlighter)\n    ? await highlighter\n    : highlighter;\n  const loaders: Promise<void>[] = [];\n  for (const language of langs) {\n    const loadedOrLoading = loadedLanguages.get(language);\n    // We haven't loaded this language yet, so lets queue it up\n    if (loadedOrLoading == null) {\n      const promise = instance\n        .loadLanguage(language)\n        .then(() => void loadedLanguages.set(language, true));\n      loadedLanguages.set(language, promise);\n      loaders.push(promise);\n    }\n    // We are currently loading the language,\n    // so lets queue the existing promise\n    else if (loadedOrLoading !== true) {\n      loaders.push(loadedOrLoading);\n    }\n  }\n  for (const themeName of themes) {\n    const loadedOrLoading = loadedThemes.get(themeName);\n    // We haven't loaded this theme yet, so lets queue it up\n    if (loadedOrLoading == null) {\n      const customTheme = CustomThemes.get(themeName);\n      const promise = instance\n        .loadTheme(customTheme != null ? customTheme() : themeName)\n        .then(() => void loadedThemes.set(themeName, true));\n      loadedThemes.set(themeName, promise);\n      loaders.push(promise);\n    }\n    // We are currently loading the theme,\n    // so lets queue the existing promise\n    else if (loadedOrLoading !== true) {\n      loaders.push(loadedOrLoading);\n    }\n  }\n  if (loaders.length > 0) {\n    await Promise.all(loaders);\n  }\n  return instance;\n}\n\nexport function hasLoadedThemes(themes: PJSThemeNames[]): boolean {\n  for (const theme of themes) {\n    if (loadedThemes.get(theme) === true) {\n      continue;\n    }\n    return false;\n  }\n  return true;\n}\n\nexport function hasLoadedLanguage(lang: SupportedLanguages): boolean {\n  return loadedLanguages.get(lang) === true;\n}\n\nexport function isHighlighterLoaded(\n  h: CachedOrLoadingHighlighterType = highlighter\n): h is PJSHighlighter {\n  return h != null && !('then' in h);\n}\n\nexport function isHighlighterLoading(\n  h: CachedOrLoadingHighlighterType = highlighter\n): h is Promise<PJSHighlighter> {\n  return h != null && 'then' in h;\n}\n\nexport function isHighlighterNull(\n  h: CachedOrLoadingHighlighterType = highlighter\n): h is undefined {\n  return h == null;\n}\n\nexport async function preloadHighlighter(\n  options: HighlighterOptions\n): Promise<void> {\n  return void (await getSharedHighlighter(options));\n}\n\nexport async function disposeHighlighter(): Promise<void> {\n  if (highlighter == null) return;\n  (await highlighter).dispose();\n  loadedThemes.clear();\n  loadedLanguages.clear();\n  highlighter = undefined;\n}\n\nconst CustomThemes = new Map<\n  string,\n  () => Promise<ThemeRegistrationResolved>\n>();\n\nexport function registerCustomTheme(\n  themeName: string,\n  loader: () => Promise<ThemeRegistrationResolved>\n): void {\n  if (CustomThemes.has(themeName)) {\n    console.error(\n      'SharedHighlight.registerCustomTheme: theme name already registered',\n      themeName\n    );\n    return;\n  }\n  CustomThemes.set(themeName, loader);\n}\n\nregisterCustomTheme(\n  'pierre-dark',\n  () =>\n    import(\n      './themes/pierre-dark.json'\n    ) as unknown as Promise<ThemeRegistrationResolved>\n);\n\nregisterCustomTheme(\n  'pierre-light',\n  () =>\n    import(\n      './themes/pierre-light.json'\n    ) as unknown as Promise<ThemeRegistrationResolved>\n);\n"],"mappings":"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"}