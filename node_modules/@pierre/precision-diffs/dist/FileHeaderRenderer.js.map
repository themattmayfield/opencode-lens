{"version":3,"file":"FileHeaderRenderer.js","names":["options: FileHeaderRendererOptions"],"sources":["../src/FileHeaderRenderer.ts"],"sourcesContent":["import type { Element } from 'hast';\nimport { toHtml } from 'hast-util-to-html';\n\nimport { getSharedHighlighter, hasLoadedThemes } from './SharedHighlighter';\nimport { DEFAULT_THEMES } from './constants';\nimport type {\n  FileContents,\n  FileDiffMetadata,\n  PJSHighlighter,\n  PJSThemeNames,\n  ThemeTypes,\n  ThemesType,\n} from './types';\nimport { getHighlighterOptions } from './utils/getHighlighterOptions';\nimport { getThemes } from './utils/getThemes';\nimport { createFileHeaderElement } from './utils/hast_utils';\n\nexport interface FileHeaderRendererOptions {\n  theme?: PJSThemeNames | ThemesType;\n  themeType?: ThemeTypes;\n}\n\nexport class FileHeaderRenderer {\n  private highlighter: PJSHighlighter | undefined;\n\n  constructor(\n    public options: FileHeaderRendererOptions = { theme: DEFAULT_THEMES }\n  ) {}\n\n  cleanUp(): void {\n    this.highlighter = undefined;\n    this.queuedRenderFileOrDiff = undefined;\n    this.queuedRender = undefined;\n  }\n\n  private mergeOptions(options: Partial<FileHeaderRendererOptions>): void {\n    this.options = { ...this.options, ...options };\n  }\n\n  setOptions(options: FileHeaderRendererOptions): void {\n    this.options = options;\n  }\n\n  setThemeType(themeType: ThemeTypes): void {\n    if ((this.options.themeType ?? 'system') === themeType) {\n      return;\n    }\n    this.mergeOptions({ themeType });\n  }\n\n  private async initializeHighlighter(): Promise<PJSHighlighter> {\n    this.highlighter = await getSharedHighlighter(\n      getHighlighterOptions(undefined, this.options)\n    );\n    return this.highlighter;\n  }\n\n  fileOrDiff: FileDiffMetadata | FileContents | undefined;\n  private queuedRenderFileOrDiff: FileDiffMetadata | FileContents | undefined;\n  private queuedRender: Promise<Element | undefined> | undefined;\n  async render(\n    fileOrDiff: FileDiffMetadata | FileContents\n  ): Promise<Element | undefined> {\n    this.queuedRenderFileOrDiff = fileOrDiff;\n    if (this.queuedRender != null) {\n      return this.queuedRender;\n    }\n    this.queuedRender = (async () => {\n      if (!hasLoadedThemes(getThemes(this.options.theme))) {\n        this.highlighter = undefined;\n      }\n      this.highlighter ??= await this.initializeHighlighter();\n      if (this.queuedRenderFileOrDiff == null) {\n        // If we get in here, it's likely we called cleanup and therefore we\n        // should just return early with empty result\n        return undefined;\n      }\n      return this.renderHeader(this.queuedRenderFileOrDiff, this.highlighter);\n    })();\n    const result = await this.queuedRender;\n    this.queuedRenderFileOrDiff = undefined;\n    this.queuedRender = undefined;\n    return result;\n  }\n\n  private renderHeader(\n    fileOrDiff: FileDiffMetadata | FileContents,\n    highlighter: PJSHighlighter\n  ): Element {\n    this.fileOrDiff = fileOrDiff;\n    return createFileHeaderElement({\n      ...this.options,\n      fileOrDiff,\n      highlighter,\n    });\n  }\n\n  renderResultToHTML(element: Element): string {\n    return toHtml(element);\n  }\n}\n"],"mappings":";;;;;;;;AAsBA,IAAa,qBAAb,MAAgC;CAC9B,AAAQ;CAER,YACE,AAAOA,UAAqC,EAAE,OAAO,gBAAgB,EACrE;EADO;;CAGT,UAAgB;AACd,OAAK,cAAc;AACnB,OAAK,yBAAyB;AAC9B,OAAK,eAAe;;CAGtB,AAAQ,aAAa,SAAmD;AACtE,OAAK,UAAU;GAAE,GAAG,KAAK;GAAS,GAAG;GAAS;;CAGhD,WAAW,SAA0C;AACnD,OAAK,UAAU;;CAGjB,aAAa,WAA6B;AACxC,OAAK,KAAK,QAAQ,aAAa,cAAc,UAC3C;AAEF,OAAK,aAAa,EAAE,WAAW,CAAC;;CAGlC,MAAc,wBAAiD;AAC7D,OAAK,cAAc,MAAM,qBACvB,sBAAsB,QAAW,KAAK,QAAQ,CAC/C;AACD,SAAO,KAAK;;CAGd;CACA,AAAQ;CACR,AAAQ;CACR,MAAM,OACJ,YAC8B;AAC9B,OAAK,yBAAyB;AAC9B,MAAI,KAAK,gBAAgB,KACvB,QAAO,KAAK;AAEd,OAAK,gBAAgB,YAAY;AAC/B,OAAI,CAAC,gBAAgB,UAAU,KAAK,QAAQ,MAAM,CAAC,CACjD,MAAK,cAAc;AAErB,QAAK,gBAAgB,MAAM,KAAK,uBAAuB;AACvD,OAAI,KAAK,0BAA0B,KAGjC;AAEF,UAAO,KAAK,aAAa,KAAK,wBAAwB,KAAK,YAAY;MACrE;EACJ,MAAM,SAAS,MAAM,KAAK;AAC1B,OAAK,yBAAyB;AAC9B,OAAK,eAAe;AACpB,SAAO;;CAGT,AAAQ,aACN,YACA,aACS;AACT,OAAK,aAAa;AAClB,SAAO,wBAAwB;GAC7B,GAAG,KAAK;GACR;GACA;GACD,CAAC;;CAGJ,mBAAmB,SAA0B;AAC3C,SAAO,OAAO,QAAQ"}