{"version":3,"file":"FileStream.js","names":["options: FileStreamOptions","linesToAppend: HTMLElement[]"],"sources":["../src/FileStream.ts"],"sourcesContent":["import { getSharedHighlighter } from './SharedHighlighter';\nimport { queueRender } from './UniversalRenderer';\nimport { DEFAULT_THEMES } from './constants';\nimport { CodeToTokenTransformStream, type RecallToken } from './shiki-stream';\nimport type {\n  BaseCodeOptions,\n  PJSHighlighter,\n  ThemeTypes,\n  ThemedToken,\n} from './types';\nimport { formatCSSVariablePrefix } from './utils/formatCSSVariablePrefix';\nimport { getHighlighterOptions } from './utils/getHighlighterOptions';\nimport {\n  createCodeNode,\n  createRow,\n  createSpanFromToken,\n  setWrapperProps,\n} from './utils/html_render_utils';\n\nexport interface FileStreamOptions extends BaseCodeOptions {\n  startingLineIndex?: number;\n\n  onPreRender?(instance: FileStream): unknown;\n  onPostRender?(instance: FileStream): unknown;\n\n  onStreamStart?(controller: WritableStreamDefaultController): unknown;\n  onStreamWrite?(token: ThemedToken | RecallToken): unknown;\n  onStreamClose?(): unknown;\n  onStreamAbort?(reason: unknown): unknown;\n}\n\nexport class FileStream {\n  private highlighter: PJSHighlighter | undefined;\n  private stream: ReadableStream<string> | undefined;\n  private fileContainer: HTMLElement | undefined;\n  pre: HTMLPreElement | undefined;\n  private code: HTMLElement | undefined;\n\n  constructor(public options: FileStreamOptions = { theme: DEFAULT_THEMES }) {\n    this.currentLineIndex = this.options.startingLineIndex ?? 1;\n  }\n\n  cleanUp(): void {\n    void this.stream?.cancel();\n  }\n\n  setThemeType(themeType: ThemeTypes): void {\n    if ((this.options.themeType ?? 'system') === themeType) {\n      return;\n    }\n    this.options = { ...this.options, themeType };\n\n    // Update pre element theme mode\n    if (this.pre != null) {\n      switch (themeType) {\n        case 'system':\n          delete this.pre.dataset.themeType;\n          break;\n        case 'light':\n        case 'dark':\n          this.pre.dataset.themeType = themeType;\n          break;\n      }\n    }\n  }\n\n  private async initializeHighlighter(): Promise<PJSHighlighter> {\n    this.highlighter = await getSharedHighlighter(\n      getHighlighterOptions(this.options.lang, this.options)\n    );\n    return this.highlighter;\n  }\n\n  private queuedSetupArgs: [ReadableStream<string>, HTMLElement] | undefined;\n  async setup(\n    _source: ReadableStream<string>,\n    _wrapper: HTMLElement\n  ): Promise<void> {\n    const isSettingUp = this.queuedSetupArgs != null;\n    this.queuedSetupArgs = [_source, _wrapper];\n    if (isSettingUp) {\n      // TODO(amadeus): Make it so that this function can be properly\n      // awaitable, maybe?\n      return;\n    }\n    this.highlighter ??= await this.initializeHighlighter();\n\n    const [source, wrapper] = this.queuedSetupArgs;\n    this.queuedSetupArgs = undefined;\n\n    const stream = source;\n\n    this.setupStream(stream, wrapper, this.highlighter);\n  }\n\n  private setupStream(\n    stream: ReadableStream<string>,\n    wrapper: HTMLElement,\n    highlighter: PJSHighlighter\n  ): void {\n    const {\n      theme = DEFAULT_THEMES,\n      overflow = 'scroll',\n      themeType = 'system',\n    } = this.options;\n    const fileContainer = this.getOrCreateFileContainer();\n    if (fileContainer.parentElement == null) {\n      wrapper.appendChild(fileContainer);\n    }\n    this.pre ??= document.createElement('pre');\n    if (this.pre.parentElement == null) {\n      fileContainer.shadowRoot?.appendChild(this.pre);\n    }\n    const pre = setWrapperProps({\n      pre: this.pre,\n      split: false,\n      theme,\n      highlighter,\n      wrap: overflow === 'wrap',\n      themeType,\n      diffIndicators: 'none',\n      disableBackground: true,\n      totalLines: 0,\n    });\n    pre.innerHTML = '';\n\n    this.pre = pre;\n    this.code = createCodeNode({ pre });\n    if (this.stream != null) {\n      // Should we be doing this?\n      void this.stream.cancel();\n    }\n    const { onStreamStart, onStreamClose, onStreamAbort } = this.options;\n    this.stream = stream;\n    void this.stream\n      .pipeThrough(\n        typeof theme === 'string'\n          ? new CodeToTokenTransformStream({\n              ...this.options,\n              theme,\n              highlighter,\n              allowRecalls: true,\n              defaultColor: false,\n              cssVariablePrefix: formatCSSVariablePrefix(),\n            })\n          : new CodeToTokenTransformStream({\n              ...this.options,\n              themes: theme,\n              highlighter,\n              allowRecalls: true,\n              defaultColor: false,\n              cssVariablePrefix: formatCSSVariablePrefix(),\n            })\n      )\n      .pipeTo(\n        new WritableStream({\n          start(controller) {\n            onStreamStart?.(controller);\n          },\n          close() {\n            onStreamClose?.();\n          },\n          abort(reason) {\n            onStreamAbort?.(reason);\n          },\n          write: this.handleWrite,\n        })\n      );\n  }\n\n  private queuedTokens: (ThemedToken | RecallToken)[] = [];\n  private handleWrite = (token: ThemedToken | RecallToken) => {\n    // If we've recalled tokens we haven't rendered yet, we can just yeet them\n    // and never apply them\n    if ('recall' in token && this.queuedTokens.length >= token.recall) {\n      this.queuedTokens.length = this.queuedTokens.length - token.recall;\n    } else {\n      this.queuedTokens.push(token);\n    }\n    queueRender(this.render);\n    this.options.onStreamWrite?.(token);\n  };\n\n  private currentLineIndex: number;\n  private currentLineElement: HTMLElement | undefined;\n  private render = () => {\n    this.options.onPreRender?.(this);\n    const linesToAppend: HTMLElement[] = [];\n    for (const token of this.queuedTokens) {\n      if ('recall' in token) {\n        if (this.currentLineElement == null) {\n          throw new Error(\n            'FileStream.render: no current line element, shouldnt be possible to get here'\n          );\n        }\n        if (token.recall > this.currentLineElement.childNodes.length) {\n          throw new Error(\n            `FileStream.render: Token recall exceed the current line, there's probably a bug...`\n          );\n        }\n        for (let i = 0; i < token.recall; i++) {\n          this.currentLineElement.lastChild?.remove();\n        }\n      } else {\n        const span = createSpanFromToken(token);\n        if (this.currentLineElement == null) {\n          linesToAppend.push(this.createLine());\n        }\n        this.currentLineElement?.appendChild(span);\n        if (token.content === '\\n') {\n          this.currentLineIndex++;\n          linesToAppend.push(this.createLine());\n        }\n      }\n    }\n    for (const line of linesToAppend) {\n      this.code?.appendChild(line);\n    }\n    this.queuedTokens.length = 0;\n    this.options.onPostRender?.(this);\n  };\n\n  private createLine(): HTMLElement {\n    const { row, content } = createRow(this.currentLineIndex);\n    this.currentLineElement = content;\n    return row;\n  }\n\n  private getOrCreateFileContainer(fileContainer?: HTMLElement): HTMLElement {\n    if (\n      (fileContainer != null && fileContainer === this.fileContainer) ||\n      (fileContainer == null && this.fileContainer != null)\n    ) {\n      return this.fileContainer;\n    }\n    this.fileContainer = fileContainer ?? document.createElement('file-diff');\n    return this.fileContainer;\n  }\n}\n"],"mappings":"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"}