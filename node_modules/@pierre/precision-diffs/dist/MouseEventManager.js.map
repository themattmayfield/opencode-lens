{"version":3,"file":"MouseEventManager.js","names":["mode: TMode","options: MouseEventManagerOptions<TMode>","reasons: string[]"],"sources":["../src/MouseEventManager.ts"],"sourcesContent":["import type {\n  AnnotationSide,\n  DiffLineEventBaseProps,\n  LineEventBaseProps,\n} from './types';\n\nexport type LogTypes = 'click' | 'move' | 'both' | 'none';\n\nexport type MouseEventManagerMode = 'file' | 'diff';\n\nexport interface OnLineClickProps extends LineEventBaseProps {\n  event: PointerEvent;\n}\n\nexport interface OnLineEnterLeaveProps extends LineEventBaseProps {\n  event: MouseEvent;\n}\n\nexport interface OnDiffLineClickProps extends DiffLineEventBaseProps {\n  event: PointerEvent;\n}\n\nexport interface OnDiffLineEnterLeaveProps extends DiffLineEventBaseProps {\n  event: MouseEvent;\n}\n\ntype HandleMouseEventProps =\n  | { eventType: 'click'; event: PointerEvent }\n  | { eventType: 'move'; event: MouseEvent };\n\ntype EventClickProps<TMode extends MouseEventManagerMode> = TMode extends 'file'\n  ? OnLineClickProps\n  : OnDiffLineClickProps;\n\ntype EventEnterLeaveProps<TMode extends MouseEventManagerMode> =\n  TMode extends 'file' ? OnLineEnterLeaveProps : OnDiffLineEnterLeaveProps;\n\ntype EventBaseProps<TMode extends MouseEventManagerMode> = TMode extends 'file'\n  ? LineEventBaseProps\n  : DiffLineEventBaseProps;\n\ninterface ExpandoEventProps {\n  type: 'line-info';\n  hunkIndex: number;\n}\n\ntype GetLineDataResult<TMode extends MouseEventManagerMode> =\n  TMode extends 'file'\n    ? LineEventBaseProps | ExpandoEventProps | undefined\n    : DiffLineEventBaseProps | ExpandoEventProps | undefined;\n\ntype LineEventData<TMode extends MouseEventManagerMode> = TMode extends 'file'\n  ? LineEventBaseProps\n  : DiffLineEventBaseProps;\n\nfunction isLineEventData<TMode extends MouseEventManagerMode>(\n  data: GetLineDataResult<TMode>,\n  mode: TMode\n): data is LineEventData<TMode> {\n  if (data == null) return false;\n  if (mode === 'file') {\n    return data.type === 'line';\n  } else {\n    return data.type === 'diff-line';\n  }\n}\n\nfunction isExpandoEventData(\n  data:\n    | LineEventBaseProps\n    | DiffLineEventBaseProps\n    | ExpandoEventProps\n    | undefined\n): data is ExpandoEventProps {\n  return data?.type === 'line-info';\n}\n\nexport interface MouseEventManagerBaseOptions<\n  TMode extends MouseEventManagerMode,\n> {\n  onLineClick?(props: EventClickProps<TMode>): unknown;\n  onLineNumberClick?(props: EventClickProps<TMode>): unknown;\n  onLineEnter?(props: EventEnterLeaveProps<TMode>): unknown;\n  onLineLeave?(props: EventEnterLeaveProps<TMode>): unknown;\n  __debugMouseEvents?: LogTypes;\n}\n\nexport interface MouseEventManagerOptions<TMode extends MouseEventManagerMode>\n  extends MouseEventManagerBaseOptions<TMode> {\n  onHunkExpand?(hunkIndex: number): unknown;\n}\n\nexport class MouseEventManager<TMode extends MouseEventManagerMode> {\n  private hoveredRow: EventBaseProps<TMode> | undefined;\n  private pre: HTMLPreElement | undefined;\n\n  constructor(\n    private mode: TMode,\n    private options: MouseEventManagerOptions<TMode>\n  ) {}\n\n  setOptions(options: MouseEventManagerOptions<TMode>): void {\n    this.options = options;\n  }\n\n  cleanUp(): void {\n    this.pre?.removeEventListener('click', this.handleMouseClick);\n    this.pre?.removeEventListener('mousemove', this.handleMouseMove);\n    this.pre?.removeEventListener('mouseout', this.handleMouseLeave);\n    delete this.pre?.dataset.interactiveLines;\n    delete this.pre?.dataset.interactiveLineNumbers;\n    this.pre = undefined;\n  }\n\n  setup(pre: HTMLPreElement): void {\n    const {\n      __debugMouseEvents,\n      onLineClick,\n      onLineNumberClick,\n      onLineEnter,\n      onLineLeave,\n      onHunkExpand,\n    } = this.options;\n\n    this.cleanUp();\n    this.pre = pre;\n\n    if (\n      onLineClick != null ||\n      onLineNumberClick != null ||\n      onHunkExpand != null\n    ) {\n      pre.addEventListener('click', this.handleMouseClick);\n      if (onLineClick != null) {\n        pre.dataset.interactiveLines = '';\n      } else if (onLineNumberClick != null) {\n        pre.dataset.interactiveLineNumbers = '';\n      }\n      debugLogIfEnabled(\n        __debugMouseEvents,\n        'click',\n        'FileDiff.DEBUG.attachEventListeners: Attaching click events for:',\n        (() => {\n          const reasons: string[] = [];\n          if (__debugMouseEvents === 'both' || __debugMouseEvents === 'click') {\n            if (onLineClick != null) {\n              reasons.push('onLineClick');\n            }\n            if (onLineNumberClick != null) {\n              reasons.push('onLineNumberClick');\n            }\n            if (onHunkExpand != null) {\n              reasons.push('expandable hunk separators');\n            }\n          }\n          return reasons;\n        })()\n      );\n    }\n    if (onLineEnter != null || onLineLeave != null) {\n      pre.addEventListener('mousemove', this.handleMouseMove);\n      debugLogIfEnabled(\n        __debugMouseEvents,\n        'move',\n        'FileDiff.DEBUG.attachEventListeners: Attaching mouse move event'\n      );\n      if (onLineLeave != null) {\n        pre.addEventListener('mouseleave', this.handleMouseLeave);\n        debugLogIfEnabled(\n          __debugMouseEvents,\n          'move',\n          'FileDiff.DEBUG.attachEventListeners: Attaching mouse leave event'\n        );\n      }\n    }\n  }\n\n  handleMouseClick = (event: PointerEvent): void => {\n    debugLogIfEnabled(\n      this.options.__debugMouseEvents,\n      'click',\n      'FileDiff.DEBUG.handleMouseClick:',\n      event\n    );\n    this.handleMouseEvent({ eventType: 'click', event });\n  };\n\n  handleMouseMove = (event: MouseEvent): void => {\n    debugLogIfEnabled(\n      this.options.__debugMouseEvents,\n      'move',\n      'FileDiff.DEBUG.handleMouseMove:',\n      event\n    );\n    this.handleMouseEvent({ eventType: 'move', event });\n  };\n\n  handleMouseLeave = (event: MouseEvent): void => {\n    const { __debugMouseEvents } = this.options;\n    debugLogIfEnabled(\n      __debugMouseEvents,\n      'move',\n      'FileDiff.DEBUG.handleMouseLeave: no event'\n    );\n    if (this.hoveredRow == null) {\n      debugLogIfEnabled(\n        __debugMouseEvents,\n        'move',\n        'FileDiff.DEBUG.handleMouseLeave: returned early, no .hoveredRow'\n      );\n      return;\n    }\n    this.options.onLineLeave?.({\n      ...this.hoveredRow,\n      event,\n    } as EventEnterLeaveProps<TMode>);\n    this.hoveredRow = undefined;\n  };\n\n  private handleMouseEvent({ eventType, event }: HandleMouseEventProps) {\n    const { __debugMouseEvents } = this.options;\n    const composedPath = event.composedPath();\n    debugLogIfEnabled(\n      __debugMouseEvents,\n      eventType,\n      'FileDiff.DEBUG.handleMouseEvent:',\n      { eventType, composedPath }\n    );\n    const data = this.getLineData(composedPath);\n    debugLogIfEnabled(\n      __debugMouseEvents,\n      eventType,\n      'FileDiff.DEBUG.handleMouseEvent: getLineData result:',\n      data\n    );\n    const {\n      onLineClick,\n      onLineNumberClick,\n      onLineEnter,\n      onLineLeave,\n      onHunkExpand,\n    } = this.options;\n    switch (eventType) {\n      case 'move': {\n        if (\n          isLineEventData(data, this.mode) &&\n          this.hoveredRow?.lineElement === data.lineElement\n        ) {\n          debugLogIfEnabled(\n            __debugMouseEvents,\n            'move',\n            \"FileDiff.DEBUG.handleMouseEvent: switch, 'move', returned early because same line\"\n          );\n          break;\n        }\n        if (this.hoveredRow != null) {\n          debugLogIfEnabled(\n            __debugMouseEvents,\n            'move',\n            \"FileDiff.DEBUG.handleMouseEvent: switch, 'move', clearing an existing hovered row and firing onLineLeave\"\n          );\n          onLineLeave?.({\n            ...this.hoveredRow,\n            event,\n          } as EventEnterLeaveProps<TMode>);\n          this.hoveredRow = undefined;\n        }\n        if (isLineEventData(data, this.mode)) {\n          debugLogIfEnabled(\n            __debugMouseEvents,\n            'move',\n            \"FileDiff.DEBUG.handleMouseEvent: switch, 'move', setting up a new hoveredRow and firing onLineEnter\"\n          );\n          this.hoveredRow = data;\n          onLineEnter?.({\n            ...this.hoveredRow,\n            event,\n          } as EventEnterLeaveProps<TMode>);\n        }\n        break;\n      }\n      case 'click':\n        debugLogIfEnabled(\n          __debugMouseEvents,\n          'click',\n          \"FileDiff.DEBUG.handleMouseEvent: switch, 'click', with data:\",\n          data\n        );\n        if (data == null) break;\n        if (isExpandoEventData(data) && onHunkExpand != null) {\n          debugLogIfEnabled(\n            __debugMouseEvents,\n            'click',\n            \"FileDiff.DEBUG.handleMouseEvent: switch, 'click', expanding a hunk\"\n          );\n          onHunkExpand(data.hunkIndex);\n          break;\n        }\n        if (isLineEventData(data, this.mode)) {\n          if (onLineNumberClick != null && data.numberColumn) {\n            debugLogIfEnabled(\n              __debugMouseEvents,\n              'click',\n              \"FileDiff.DEBUG.handleMouseEvent: switch, 'click', firing 'onLineNumberClick'\"\n            );\n            onLineNumberClick({ ...data, event } as EventClickProps<TMode>);\n          } else if (onLineClick != null) {\n            debugLogIfEnabled(\n              __debugMouseEvents,\n              'click',\n              \"FileDiff.DEBUG.handleMouseEvent: switch, 'click', firing 'onLineClick'\"\n            );\n            onLineClick({ ...data, event } as EventClickProps<TMode>);\n          } else {\n            debugLogIfEnabled(\n              __debugMouseEvents,\n              'click',\n              \"FileDiff.DEBUG.handleMouseEvent: switch, 'click', fell through, no event to fire\"\n            );\n          }\n        }\n        break;\n    }\n  }\n\n  private getLineData(path: EventTarget[]): GetLineDataResult<TMode> {\n    let numberColumn = false;\n    const lineElement = path.find((element) => {\n      if (!(element instanceof HTMLElement)) {\n        return false;\n      }\n      numberColumn = numberColumn || 'columnNumber' in element.dataset;\n      return 'line' in element.dataset || 'expandIndex' in element.dataset;\n    });\n    if (!(lineElement instanceof HTMLElement)) return undefined;\n    if (lineElement.dataset.expandIndex != null) {\n      const hunkIndex = parseInt(lineElement.dataset.expandIndex);\n      if (isNaN(hunkIndex)) {\n        return undefined;\n      }\n      return {\n        type: 'line-info',\n        hunkIndex,\n      };\n    }\n    const lineNumber = parseInt(lineElement.dataset.line ?? '');\n    if (isNaN(lineNumber)) return;\n    const lineType = lineElement.dataset.lineType;\n    if (\n      lineType !== 'context' &&\n      lineType !== 'context-expanded' &&\n      lineType !== 'change-deletion' &&\n      lineType !== 'change-addition'\n    ) {\n      return undefined;\n    }\n\n    if (this.mode === 'file') {\n      return {\n        type: 'line',\n        lineElement,\n        lineNumber,\n        numberColumn,\n      } as GetLineDataResult<TMode>;\n    }\n\n    const annotationSide: AnnotationSide = (() => {\n      if (lineType === 'change-deletion') {\n        return 'deletions';\n      }\n      if (lineType === 'change-addition') {\n        return 'additions';\n      }\n      const parent = lineElement.closest('[data-code]');\n      if (!(parent instanceof HTMLElement)) {\n        return 'additions';\n      }\n      return 'deletions' in parent.dataset ? 'deletions' : 'additions';\n    })();\n\n    return {\n      type: 'diff-line',\n      annotationSide,\n      lineType,\n      lineElement,\n      lineNumber,\n      numberColumn,\n    } as GetLineDataResult<TMode>;\n  }\n}\n\nfunction debugLogIfEnabled(\n  debugLogType: LogTypes | undefined = 'none',\n  logIfType: 'move' | 'click',\n  ...args: unknown[]\n) {\n  switch (debugLogType) {\n    case 'none':\n      return;\n    case 'both':\n      break;\n    case 'click':\n      if (logIfType !== 'click') {\n        return;\n      }\n      break;\n    case 'move':\n      if (logIfType !== 'move') {\n        return;\n      }\n      break;\n  }\n  console.log(...args);\n}\n\nexport function getMouseEventOptions<TMode extends MouseEventManagerMode>(\n  {\n    onLineClick,\n    onLineNumberClick,\n    onLineEnter,\n    onLineLeave,\n    __debugMouseEvents,\n  }: MouseEventManagerBaseOptions<TMode>,\n  onHunkExpand?: (hunkIndex: number) => unknown\n): MouseEventManagerOptions<TMode> {\n  return {\n    onLineClick,\n    onLineNumberClick,\n    onLineEnter,\n    onLineLeave,\n    __debugMouseEvents,\n    onHunkExpand,\n  };\n}\n"],"mappings":";AAuDA,SAAS,gBACP,MACA,MAC8B;AAC9B,KAAI,QAAQ,KAAM,QAAO;AACzB,KAAI,SAAS,OACX,QAAO,KAAK,SAAS;KAErB,QAAO,KAAK,SAAS;;AAIzB,SAAS,mBACP,MAK2B;AAC3B,QAAO,MAAM,SAAS;;AAkBxB,IAAa,oBAAb,MAAoE;CAClE,AAAQ;CACR,AAAQ;CAER,YACE,AAAQA,MACR,AAAQC,SACR;EAFQ;EACA;;CAGV,WAAW,SAAgD;AACzD,OAAK,UAAU;;CAGjB,UAAgB;AACd,OAAK,KAAK,oBAAoB,SAAS,KAAK,iBAAiB;AAC7D,OAAK,KAAK,oBAAoB,aAAa,KAAK,gBAAgB;AAChE,OAAK,KAAK,oBAAoB,YAAY,KAAK,iBAAiB;AAChE,SAAO,KAAK,KAAK,QAAQ;AACzB,SAAO,KAAK,KAAK,QAAQ;AACzB,OAAK,MAAM;;CAGb,MAAM,KAA2B;EAC/B,MAAM,EACJ,oBACA,aACA,mBACA,aACA,aACA,iBACE,KAAK;AAET,OAAK,SAAS;AACd,OAAK,MAAM;AAEX,MACE,eAAe,QACf,qBAAqB,QACrB,gBAAgB,MAChB;AACA,OAAI,iBAAiB,SAAS,KAAK,iBAAiB;AACpD,OAAI,eAAe,KACjB,KAAI,QAAQ,mBAAmB;YACtB,qBAAqB,KAC9B,KAAI,QAAQ,yBAAyB;AAEvC,qBACE,oBACA,SACA,2EACO;IACL,MAAMC,UAAoB,EAAE;AAC5B,QAAI,uBAAuB,UAAU,uBAAuB,SAAS;AACnE,SAAI,eAAe,KACjB,SAAQ,KAAK,cAAc;AAE7B,SAAI,qBAAqB,KACvB,SAAQ,KAAK,oBAAoB;AAEnC,SAAI,gBAAgB,KAClB,SAAQ,KAAK,6BAA6B;;AAG9C,WAAO;OACL,CACL;;AAEH,MAAI,eAAe,QAAQ,eAAe,MAAM;AAC9C,OAAI,iBAAiB,aAAa,KAAK,gBAAgB;AACvD,qBACE,oBACA,QACA,kEACD;AACD,OAAI,eAAe,MAAM;AACvB,QAAI,iBAAiB,cAAc,KAAK,iBAAiB;AACzD,sBACE,oBACA,QACA,mEACD;;;;CAKP,oBAAoB,UAA8B;AAChD,oBACE,KAAK,QAAQ,oBACb,SACA,oCACA,MACD;AACD,OAAK,iBAAiB;GAAE,WAAW;GAAS;GAAO,CAAC;;CAGtD,mBAAmB,UAA4B;AAC7C,oBACE,KAAK,QAAQ,oBACb,QACA,mCACA,MACD;AACD,OAAK,iBAAiB;GAAE,WAAW;GAAQ;GAAO,CAAC;;CAGrD,oBAAoB,UAA4B;EAC9C,MAAM,EAAE,uBAAuB,KAAK;AACpC,oBACE,oBACA,QACA,4CACD;AACD,MAAI,KAAK,cAAc,MAAM;AAC3B,qBACE,oBACA,QACA,kEACD;AACD;;AAEF,OAAK,QAAQ,cAAc;GACzB,GAAG,KAAK;GACR;GACD,CAAgC;AACjC,OAAK,aAAa;;CAGpB,AAAQ,iBAAiB,EAAE,WAAW,SAAgC;EACpE,MAAM,EAAE,uBAAuB,KAAK;EACpC,MAAM,eAAe,MAAM,cAAc;AACzC,oBACE,oBACA,WACA,oCACA;GAAE;GAAW;GAAc,CAC5B;EACD,MAAM,OAAO,KAAK,YAAY,aAAa;AAC3C,oBACE,oBACA,WACA,wDACA,KACD;EACD,MAAM,EACJ,aACA,mBACA,aACA,aACA,iBACE,KAAK;AACT,UAAQ,WAAR;GACE,KAAK;AACH,QACE,gBAAgB,MAAM,KAAK,KAAK,IAChC,KAAK,YAAY,gBAAgB,KAAK,aACtC;AACA,uBACE,oBACA,QACA,oFACD;AACD;;AAEF,QAAI,KAAK,cAAc,MAAM;AAC3B,uBACE,oBACA,QACA,2GACD;AACD,mBAAc;MACZ,GAAG,KAAK;MACR;MACD,CAAgC;AACjC,UAAK,aAAa;;AAEpB,QAAI,gBAAgB,MAAM,KAAK,KAAK,EAAE;AACpC,uBACE,oBACA,QACA,sGACD;AACD,UAAK,aAAa;AAClB,mBAAc;MACZ,GAAG,KAAK;MACR;MACD,CAAgC;;AAEnC;GAEF,KAAK;AACH,sBACE,oBACA,SACA,gEACA,KACD;AACD,QAAI,QAAQ,KAAM;AAClB,QAAI,mBAAmB,KAAK,IAAI,gBAAgB,MAAM;AACpD,uBACE,oBACA,SACA,qEACD;AACD,kBAAa,KAAK,UAAU;AAC5B;;AAEF,QAAI,gBAAgB,MAAM,KAAK,KAAK,CAClC,KAAI,qBAAqB,QAAQ,KAAK,cAAc;AAClD,uBACE,oBACA,SACA,+EACD;AACD,uBAAkB;MAAE,GAAG;MAAM;MAAO,CAA2B;eACtD,eAAe,MAAM;AAC9B,uBACE,oBACA,SACA,yEACD;AACD,iBAAY;MAAE,GAAG;MAAM;MAAO,CAA2B;UAEzD,mBACE,oBACA,SACA,mFACD;AAGL;;;CAIN,AAAQ,YAAY,MAA+C;EACjE,IAAI,eAAe;EACnB,MAAM,cAAc,KAAK,MAAM,YAAY;AACzC,OAAI,EAAE,mBAAmB,aACvB,QAAO;AAET,kBAAe,gBAAgB,kBAAkB,QAAQ;AACzD,UAAO,UAAU,QAAQ,WAAW,iBAAiB,QAAQ;IAC7D;AACF,MAAI,EAAE,uBAAuB,aAAc,QAAO;AAClD,MAAI,YAAY,QAAQ,eAAe,MAAM;GAC3C,MAAM,YAAY,SAAS,YAAY,QAAQ,YAAY;AAC3D,OAAI,MAAM,UAAU,CAClB;AAEF,UAAO;IACL,MAAM;IACN;IACD;;EAEH,MAAM,aAAa,SAAS,YAAY,QAAQ,QAAQ,GAAG;AAC3D,MAAI,MAAM,WAAW,CAAE;EACvB,MAAM,WAAW,YAAY,QAAQ;AACrC,MACE,aAAa,aACb,aAAa,sBACb,aAAa,qBACb,aAAa,kBAEb;AAGF,MAAI,KAAK,SAAS,OAChB,QAAO;GACL,MAAM;GACN;GACA;GACA;GACD;AAiBH,SAAO;GACL,MAAM;GACN,uBAhB4C;AAC5C,QAAI,aAAa,kBACf,QAAO;AAET,QAAI,aAAa,kBACf,QAAO;IAET,MAAM,SAAS,YAAY,QAAQ,cAAc;AACjD,QAAI,EAAE,kBAAkB,aACtB,QAAO;AAET,WAAO,eAAe,OAAO,UAAU,cAAc;OACnD;GAKF;GACA;GACA;GACA;GACD;;;AAIL,SAAS,kBACP,eAAqC,QACrC,WACA,GAAG,MACH;AACA,SAAQ,cAAR;EACE,KAAK,OACH;EACF,KAAK,OACH;EACF,KAAK;AACH,OAAI,cAAc,QAChB;AAEF;EACF,KAAK;AACH,OAAI,cAAc,OAChB;AAEF;;AAEJ,SAAQ,IAAI,GAAG,KAAK;;AAGtB,SAAgB,qBACd,EACE,aACA,mBACA,aACA,aACA,sBAEF,cACiC;AACjC,QAAO;EACL;EACA;EACA;EACA;EACA;EACA;EACD"}