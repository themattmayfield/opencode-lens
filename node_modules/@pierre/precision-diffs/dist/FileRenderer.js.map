{"version":3,"file":"FileRenderer.js","names":["options: FileRendererOptions","firstChild: RootContent | Element | Root | null","lineInfoMap: Record<number, LineInfo | undefined>","lineInfo: LineInfo"],"sources":["../src/FileRenderer.ts"],"sourcesContent":["import type { Element, ElementContent, Root, RootContent } from 'hast';\nimport { toHtml } from 'hast-util-to-html';\n\nimport {\n  getSharedHighlighter,\n  hasLoadedLanguage,\n  hasLoadedThemes,\n} from './SharedHighlighter';\nimport { DEFAULT_THEMES, SPLIT_WITH_NEWLINES } from './constants';\nimport type {\n  BaseCodeOptions,\n  CodeToHastOptions,\n  DecorationItem,\n  FileContents,\n  LineAnnotation,\n  LineInfo,\n  PJSHighlighter,\n  PJSThemeNames,\n  ShikiTransformer,\n  SupportedLanguages,\n  ThemeTypes,\n} from './types';\nimport { createTransformerWithState } from './utils/createTransformerWithState';\nimport { formatCSSVariablePrefix } from './utils/formatCSSVariablePrefix';\nimport { getFiletypeFromFileName } from './utils/getFiletypeFromFileName';\nimport { getHighlighterOptions } from './utils/getHighlighterOptions';\nimport { getLineAnnotationName } from './utils/getLineAnnotationName';\nimport { getThemes } from './utils/getThemes';\nimport {\n  createHastElement,\n  createPreWrapperProperties,\n} from './utils/hast_utils';\n\ntype AnnotationLineMap<LAnnotation> = Record<\n  number,\n  LineAnnotation<LAnnotation>[] | undefined\n>;\n\nexport interface FileRenderResult {\n  codeAST: ElementContent[];\n  preNode: Element;\n  css: string;\n  totalLines: number;\n}\n\ninterface FileRendererOptions extends BaseCodeOptions {\n  startingLineNumber?: number;\n  maxLineLengthForHighlighting?: number; // 1000 is default\n}\n\nexport class FileRenderer<LAnnotation = undefined> {\n  highlighter: PJSHighlighter | undefined;\n  fileContent: string | undefined;\n\n  constructor(\n    public options: FileRendererOptions = { theme: DEFAULT_THEMES }\n  ) {}\n\n  setOptions(options: FileRendererOptions): void {\n    this.options = options;\n  }\n\n  private mergeOptions(options: Partial<FileRendererOptions>): void {\n    this.options = { ...this.options, ...options };\n  }\n\n  setThemeType(themeType: ThemeTypes): void {\n    const currentThemeType = this.options.themeType ?? 'system';\n    if (currentThemeType === themeType) {\n      return;\n    }\n    this.mergeOptions({ themeType });\n  }\n\n  private lineAnnotations: AnnotationLineMap<LAnnotation> = {};\n  setLineAnnotations(lineAnnotations: LineAnnotation<LAnnotation>[]): void {\n    this.lineAnnotations = {};\n    for (const annotation of lineAnnotations) {\n      const arr = this.lineAnnotations[annotation.lineNumber] ?? [];\n      this.lineAnnotations[annotation.lineNumber] = arr;\n      arr.push(annotation);\n    }\n  }\n\n  cleanUp(): void {\n    this.highlighter = undefined;\n    this.fileContent = undefined;\n    this.queuedFile = undefined;\n  }\n\n  private computedLang: SupportedLanguages = 'text';\n  private queuedFile: FileContents | undefined;\n  private queuedRender: Promise<FileRenderResult | undefined> | undefined;\n  async render(\n    file: FileContents,\n    useCSSClasses: boolean = false\n  ): Promise<FileRenderResult | undefined> {\n    this.queuedFile = file;\n    if (this.queuedRender != null) {\n      return this.queuedRender;\n    }\n    this.queuedRender = (async () => {\n      this.computedLang =\n        this.options.lang ?? getFiletypeFromFileName(file.name);\n      if (\n        !hasLoadedLanguage(this.computedLang) ||\n        !hasLoadedThemes(getThemes(this.options.theme))\n      ) {\n        this.highlighter = undefined;\n      }\n      this.highlighter ??= await this.initializeHighlighter();\n      if (this.queuedFile == null) {\n        return undefined;\n      }\n      return this.renderFile(this.queuedFile, this.highlighter, useCSSClasses);\n    })();\n    const result = await this.queuedRender;\n    this.queuedFile = undefined;\n    this.queuedRender = undefined;\n    return result;\n  }\n\n  private renderFile(\n    file: FileContents,\n    highlighter: PJSHighlighter,\n    useCSSClasses: boolean\n  ): FileRenderResult {\n    const { theme, themeType, disableLineNumbers = false } = this.options;\n    const { state, transformers, toClass } = createTransformerWithState({\n      disableLineNumbers,\n      useCSSClasses,\n    });\n\n    const { lineInfoMap, hasLongLines } = this.computeLineInfo(file.contents);\n    state.lineInfo = lineInfoMap;\n    const codeAST = this.getLineNodes(\n      highlighter.codeToHast(\n        file.contents.replace(/\\n$/, ''),\n        this.createHastOptions(transformers, undefined, hasLongLines)\n      )\n    );\n\n    return {\n      codeAST,\n      preNode: createHastElement({\n        tagName: 'pre',\n        properties: createPreWrapperProperties({\n          diffIndicators: 'none',\n          disableBackground: true,\n          highlighter,\n          overflow: this.options.overflow,\n          split: false,\n          theme,\n          themeType,\n          totalLines: codeAST.length,\n        }),\n      }),\n      totalLines: codeAST.length,\n      css: toClass.getCSS(),\n    };\n  }\n\n  renderFullHTML(result: FileRenderResult): string {\n    return toHtml(this.renderFullAST(result));\n  }\n\n  renderFullAST(\n    result: FileRenderResult,\n    children: ElementContent[] = []\n  ): Element {\n    children.push(\n      createHastElement({\n        tagName: 'code',\n        children: result.codeAST,\n        properties: { 'data-code': '' },\n      })\n    );\n    return { ...result.preNode, children };\n  }\n\n  renderPartialHTML(\n    children: ElementContent[],\n    includeCodeNode: boolean = false\n  ): string {\n    if (!includeCodeNode) {\n      return toHtml(children);\n    }\n    return toHtml(\n      createHastElement({\n        tagName: 'code',\n        children,\n        properties: { 'data-code': '' },\n      })\n    );\n  }\n\n  private getLineNodes(nodes: Root): ElementContent[] {\n    let firstChild: RootContent | Element | Root | null = nodes.children[0];\n    while (firstChild != null) {\n      if (firstChild.type === 'element' && firstChild.tagName === 'code') {\n        return firstChild.children;\n      }\n      if ('children' in firstChild) {\n        firstChild = firstChild.children[0];\n      } else {\n        firstChild = null;\n      }\n    }\n    console.error(nodes);\n    throw new Error(\n      'DiffHunksRenderer.getNodesToRender: Unable to find children'\n    );\n  }\n\n  private computeLineInfo(contents: string): {\n    lineInfoMap: Record<number, LineInfo | undefined>;\n    hasLongLines: boolean;\n  } {\n    const { startingLineNumber = 1, maxLineLengthForHighlighting = 1000 } =\n      this.options;\n    const lineInfoMap: Record<number, LineInfo | undefined> = {};\n    let hasLongLines = false;\n\n    let lineIndex = 0;\n    for (const line of contents.split(SPLIT_WITH_NEWLINES)) {\n      hasLongLines = hasLongLines || line.length > maxLineLengthForHighlighting;\n\n      const lineInfo: LineInfo = {\n        type: 'context',\n        lineIndex,\n        lineNumber: startingLineNumber + lineIndex,\n      };\n      const annotations = this.lineAnnotations[startingLineNumber + lineIndex];\n      if (annotations != null) {\n        lineInfo.spans = [\n          {\n            type: 'annotation',\n            hunkIndex: 0,\n            lineIndex,\n            annotations: annotations.map((annotation) =>\n              getLineAnnotationName(annotation)\n            ),\n          },\n        ];\n      }\n      lineInfoMap[lineIndex + 1] = lineInfo;\n      lineIndex++;\n    }\n    return { lineInfoMap, hasLongLines };\n  }\n\n  private createHastOptions(\n    transformers: ShikiTransformer[],\n    decorations?: DecorationItem[],\n    forceTextLang: boolean = false\n  ): CodeToHastOptions<PJSThemeNames> {\n    const { theme = DEFAULT_THEMES } = this.options;\n    if (typeof theme === 'string') {\n      return {\n        theme,\n        cssVariablePrefix: formatCSSVariablePrefix(),\n        lang: forceTextLang ? 'text' : this.computedLang,\n        defaultColor: false,\n        transformers,\n        decorations,\n      };\n    }\n    return {\n      themes: theme,\n      cssVariablePrefix: formatCSSVariablePrefix(),\n      lang: forceTextLang ? 'text' : this.computedLang,\n      defaultColor: false,\n      transformers,\n      decorations,\n    };\n  }\n\n  async initializeHighlighter(): Promise<PJSHighlighter> {\n    this.highlighter = await getSharedHighlighter(\n      getHighlighterOptions(this.computedLang, this.options)\n    );\n    return this.highlighter;\n  }\n}\n"],"mappings":"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"}