{"version":3,"file":"FileDiff.js","names":["options: FileDiffOptions<LAnnotation>","codeDeletions: HTMLElement | undefined","codeAdditions: HTMLElement | undefined"],"sources":["../src/FileDiff.ts"],"sourcesContent":["import deepEquals from 'fast-deep-equal';\nimport type { Element } from 'hast';\n\nimport { DiffHunksRenderer, type HunksRenderResult } from './DiffHunksRenderer';\nimport { FileHeaderRenderer } from './FileHeaderRenderer';\nimport {\n  MouseEventManager,\n  type MouseEventManagerBaseOptions,\n  getMouseEventOptions,\n} from './MouseEventManager';\nimport { ResizeManager } from './ResizeManager';\nimport { ScrollSyncManager } from './ScrollSyncManager';\nimport { getSharedHighlighter } from './SharedHighlighter';\nimport { DEFAULT_THEMES, HEADER_METADATA_SLOT_ID } from './constants';\nimport { PJSContainerLoaded } from './custom-components/Container';\nimport { SVGSpriteSheet } from './sprite';\nimport type {\n  BaseDiffOptions,\n  DiffLineAnnotation,\n  FileContents,\n  FileDiffMetadata,\n  HunkData,\n  HunkSeparators,\n  PJSHighlighter,\n  RenderHeaderMetadataCallback,\n  ThemeTypes,\n} from './types';\nimport { getLineAnnotationName } from './utils/getLineAnnotationName';\nimport { getThemes } from './utils/getThemes';\nimport { createCodeNode, setWrapperProps } from './utils/html_render_utils';\nimport { parseDiffFromFile } from './utils/parseDiffFromFile';\n\ninterface FileDiffRenderProps<LAnnotation> {\n  fileDiff?: FileDiffMetadata;\n  oldFile?: FileContents;\n  newFile?: FileContents;\n  forceRender?: boolean;\n  fileContainer?: HTMLElement;\n  containerWrapper?: HTMLElement;\n  lineAnnotations?: DiffLineAnnotation<LAnnotation>[];\n}\n\nexport interface FileDiffOptions<LAnnotation>\n  extends Omit<BaseDiffOptions, 'hunkSeparators'>,\n    MouseEventManagerBaseOptions<'diff'> {\n  hunkSeparators?:\n    | Exclude<HunkSeparators, 'custom'>\n    | ((hunk: HunkData) => HTMLElement | DocumentFragment);\n  disableFileHeader?: boolean;\n  renderHeaderMetadata?: RenderHeaderMetadataCallback;\n  renderAnnotation?(\n    annotation: DiffLineAnnotation<LAnnotation>\n  ): HTMLElement | undefined;\n}\n\nlet instanceId = -1;\n\nexport class FileDiff<LAnnotation = undefined> {\n  // NOTE(amadeus): We sorta need this to ensure the web-component file is\n  // properly loaded\n  static LoadedCustomComponent: boolean = PJSContainerLoaded;\n\n  readonly __id: number = ++instanceId;\n\n  private fileContainer: HTMLElement | undefined;\n  private spriteSVG: SVGElement | undefined;\n  private pre: HTMLPreElement | undefined;\n  private unsafeCSSStyle: HTMLStyleElement | undefined;\n\n  private headerElement: HTMLElement | undefined;\n  private headerMetadata: HTMLElement | undefined;\n  private customHunkElements: HTMLElement[] = [];\n\n  private hunksRenderer: DiffHunksRenderer<LAnnotation>;\n  private headerRenderer: FileHeaderRenderer;\n  private resizeManager: ResizeManager;\n  private scrollSyncManager: ScrollSyncManager;\n  private mouseEventManager: MouseEventManager<'diff'>;\n\n  private annotationElements: HTMLElement[] = [];\n  private lineAnnotations: DiffLineAnnotation<LAnnotation>[] = [];\n\n  private oldFile: FileContents | undefined;\n  private newFile: FileContents | undefined;\n  private fileDiff: FileDiffMetadata | undefined;\n\n  constructor(\n    public options: FileDiffOptions<LAnnotation> = { theme: DEFAULT_THEMES },\n    // NOTE(amadeus): Temp hack while we use this component in a react context\n    private isContainerManaged = false\n  ) {\n    this.hunksRenderer = new DiffHunksRenderer({\n      ...options,\n      hunkSeparators:\n        typeof options.hunkSeparators === 'function'\n          ? 'custom'\n          : options.hunkSeparators,\n    });\n    this.headerRenderer = new FileHeaderRenderer(options);\n    this.resizeManager = new ResizeManager();\n    this.scrollSyncManager = new ScrollSyncManager();\n    this.mouseEventManager = new MouseEventManager(\n      'diff',\n      getMouseEventOptions(\n        options,\n        typeof options.hunkSeparators === 'function' ||\n          (options.hunkSeparators ?? 'line-info') === 'line-info'\n          ? this.handleExpandHunk\n          : undefined\n      )\n    );\n  }\n\n  // FIXME(amadeus): This is a bit of a looming issue that I'll need to resolve:\n  // * Do we publicly allow merging of options or do we have individualized setters?\n  // * When setting new options, we need to figure out what settings require a\n  //   re-render and which can just be applied more elegantly\n  // * There's also an issue of options that live here on the File class and\n  //   those that live on the Hunk class, and it's a bit of an issue with passing\n  //   settings down and mirroring them (not great...)\n  setOptions(options: FileDiffOptions<LAnnotation> | undefined): void {\n    if (options == null) return;\n    this.options = options;\n    this.hunksRenderer.setOptions({\n      ...this.options,\n      hunkSeparators:\n        typeof options.hunkSeparators === 'function'\n          ? 'custom'\n          : options.hunkSeparators,\n    });\n    this.mouseEventManager.setOptions(\n      getMouseEventOptions(\n        options,\n        typeof options.hunkSeparators === 'function' ||\n          (options.hunkSeparators ?? 'line-info') === 'line-info'\n          ? this.handleExpandHunk\n          : undefined\n      )\n    );\n  }\n\n  private mergeOptions(options: Partial<FileDiffOptions<LAnnotation>>): void {\n    this.options = { ...this.options, ...options };\n  }\n\n  setThemeType(themeType: ThemeTypes): void {\n    if ((this.options.themeType ?? 'system') === themeType) {\n      return;\n    }\n    this.mergeOptions({ themeType });\n    this.hunksRenderer.setThemeType(themeType);\n    this.headerRenderer.setThemeType(themeType);\n\n    if (this.headerElement != null) {\n      if (themeType === 'system') {\n        delete this.headerElement.dataset.themeType;\n      } else {\n        this.headerElement.dataset.themeType = themeType;\n      }\n    }\n\n    // Update pre element theme mode\n    if (this.pre != null) {\n      switch (themeType) {\n        case 'system':\n          delete this.pre.dataset.themeType;\n          break;\n        case 'light':\n        case 'dark':\n          this.pre.dataset.themeType = themeType;\n          break;\n      }\n    }\n  }\n\n  setLineAnnotations(lineAnnotations: DiffLineAnnotation<LAnnotation>[]): void {\n    this.lineAnnotations = lineAnnotations;\n  }\n\n  cleanUp(): void {\n    this.hunksRenderer.cleanUp();\n    this.headerRenderer.cleanUp();\n    this.resizeManager.cleanUp();\n    this.mouseEventManager.cleanUp();\n    this.scrollSyncManager.cleanUp();\n\n    // Clean up the data\n    this.fileDiff = undefined;\n    this.oldFile = undefined;\n    this.newFile = undefined;\n\n    // Clean up the elements\n    if (!this.isContainerManaged) {\n      this.fileContainer?.parentNode?.removeChild(this.fileContainer);\n    }\n    this.fileContainer = undefined;\n    this.pre = undefined;\n    this.headerElement = undefined;\n  }\n\n  async hydrate(props: FileDiffRenderProps<LAnnotation>): Promise<void> {\n    if (props.fileContainer == null) {\n      throw new Error(\n        'FileDiff: you must provide a fileContainer on hydration'\n      );\n    }\n    for (const element of Array.from(\n      props.fileContainer.shadowRoot?.children ?? []\n    )) {\n      if (element instanceof SVGElement) {\n        this.spriteSVG = element;\n        continue;\n      }\n      if (!(element instanceof HTMLElement)) {\n        continue;\n      }\n      if (element instanceof HTMLPreElement) {\n        this.pre = element;\n        continue;\n      }\n      if ('pjsHeader' in element.dataset) {\n        this.headerElement = element;\n        continue;\n      }\n      if (element instanceof HTMLStyleElement) {\n        this.unsafeCSSStyle = element;\n        continue;\n      }\n    }\n    // If we have no pre tag, then we should render\n    if (this.pre == null) {\n      await this.render(props);\n    }\n    // Otherwise orchestrate our setup\n    else {\n      this.fileContainer = props.fileContainer;\n      delete this.pre.dataset.dehydrated;\n\n      this.lineAnnotations = props.lineAnnotations ?? this.lineAnnotations;\n      this.newFile = props.newFile;\n      this.oldFile = props.oldFile;\n      this.fileDiff = props.fileDiff;\n\n      void this.hunksRenderer.initializeHighlighter();\n      // FIXME(amadeus): not sure how to handle this yet...\n      // this.renderSeparators();\n      this.renderAnnotations();\n      this.injectUnsafeCSS();\n      this.mouseEventManager.setup(this.pre);\n      if ((this.options.overflow ?? 'scroll') === 'scroll') {\n        this.resizeManager.setup(this.pre);\n        this.scrollSyncManager.setup(this.pre);\n      }\n    }\n  }\n\n  async rerender(): Promise<void> {\n    await this.render({\n      oldFile: this.oldFile,\n      newFile: this.newFile,\n      fileDiff: this.fileDiff,\n      forceRender: true,\n    });\n  }\n\n  handleExpandHunk = (hunkIndex: number): void => {\n    this.hunksRenderer.expandHunk(hunkIndex);\n    void this.rerender();\n  };\n\n  async render({\n    oldFile,\n    newFile,\n    fileDiff,\n    fileContainer,\n    forceRender = false,\n    lineAnnotations,\n    containerWrapper,\n  }: FileDiffRenderProps<LAnnotation>): Promise<void> {\n    const annotationsChanged =\n      lineAnnotations != null &&\n      // Ideally this would just a quick === check because lineAnnotations is\n      // unbounded\n      !deepEquals(lineAnnotations, this.lineAnnotations);\n    if (\n      !forceRender &&\n      oldFile != null &&\n      newFile != null &&\n      !annotationsChanged &&\n      deepEquals(oldFile, this.oldFile) &&\n      deepEquals(newFile, this.newFile)\n    ) {\n      return;\n    }\n    if (\n      !forceRender &&\n      fileDiff != null &&\n      fileDiff === this.fileDiff &&\n      !annotationsChanged\n    ) {\n      return;\n    }\n\n    this.oldFile = oldFile;\n    this.newFile = newFile;\n    if (fileDiff != null) {\n      this.fileDiff = fileDiff;\n    } else if (oldFile != null && newFile != null) {\n      this.fileDiff = parseDiffFromFile(oldFile, newFile);\n    }\n\n    if (lineAnnotations != null) {\n      this.setLineAnnotations(lineAnnotations);\n    }\n    if (this.fileDiff == null) {\n      return;\n    }\n    this.hunksRenderer.setOptions({\n      ...this.options,\n      hunkSeparators:\n        typeof this.options.hunkSeparators === 'function'\n          ? 'custom'\n          : this.options.hunkSeparators,\n    });\n\n    // This is kinda jank, lol\n    this.hunksRenderer.setLineAnnotations(this.lineAnnotations);\n\n    const { disableFileHeader = false } = this.options;\n\n    if (disableFileHeader) {\n      this.headerRenderer.cleanUp();\n      // Remove existing header from DOM\n      if (this.headerElement != null) {\n        this.headerElement.parentNode?.removeChild(this.headerElement);\n        this.headerElement = undefined;\n      }\n    } else {\n      const { theme, themeType } = this.options;\n      this.headerRenderer.setOptions({ theme, themeType });\n    }\n\n    const [highlighter, headerResult, hunksResult] = await Promise.all([\n      getSharedHighlighter({\n        themes: getThemes(this.options.theme),\n        langs: [],\n      }),\n      !disableFileHeader\n        ? this.headerRenderer.render(this.fileDiff)\n        : undefined,\n      this.hunksRenderer.render(this.fileDiff),\n    ]);\n\n    // If both are null, most likely a cleanup, lets abort\n    if (headerResult == null && hunksResult == null) {\n      return;\n    }\n\n    fileContainer = this.getOrCreateFileContainer(fileContainer);\n    if (headerResult != null) {\n      this.applyHeaderToDOM(headerResult, fileContainer);\n    }\n    if (hunksResult != null) {\n      if (containerWrapper != null) {\n        containerWrapper.appendChild(fileContainer);\n      }\n      const pre = this.getOrCreatePre(fileContainer);\n      this.applyHunksToDOM(hunksResult, pre, highlighter);\n      this.renderSeparators(hunksResult.hunkData);\n      this.renderAnnotations();\n    }\n  }\n\n  private renderSeparators(hunkData: HunkData[]): void {\n    const { hunkSeparators } = this.options;\n    if (\n      this.isContainerManaged ||\n      this.fileContainer == null ||\n      typeof hunkSeparators !== 'function'\n    ) {\n      return;\n    }\n    for (const element of this.customHunkElements) {\n      element.parentNode?.removeChild(element);\n    }\n    this.customHunkElements.length = 0;\n    for (const hunk of hunkData) {\n      const element = document.createElement('div');\n      element.style.display = 'contents';\n      element.slot = hunk.slotName;\n      element.appendChild(hunkSeparators(hunk));\n      this.fileContainer.appendChild(element);\n      this.customHunkElements.push(element);\n    }\n  }\n\n  private renderAnnotations(): void {\n    if (this.isContainerManaged || this.fileContainer == null) {\n      return;\n    }\n    // Handle annotation elements\n    for (const element of this.annotationElements) {\n      element.parentNode?.removeChild(element);\n    }\n    this.annotationElements.length = 0;\n\n    const { renderAnnotation } = this.options;\n    if (renderAnnotation != null && this.lineAnnotations.length > 0) {\n      for (const annotation of this.lineAnnotations) {\n        const content = renderAnnotation(annotation);\n        if (content == null) continue;\n        const el = document.createElement('div');\n        el.dataset.annotationSlot = '';\n        el.slot = getLineAnnotationName(annotation);\n        el.appendChild(content);\n        this.annotationElements.push(el);\n        this.fileContainer.appendChild(el);\n      }\n    }\n  }\n\n  private getOrCreateFileContainer(fileContainer?: HTMLElement): HTMLElement {\n    this.fileContainer =\n      fileContainer ??\n      this.fileContainer ??\n      document.createElement('file-diff');\n    if (this.spriteSVG == null) {\n      const fragment = document.createElement('div');\n      fragment.innerHTML = SVGSpriteSheet;\n      const firstChild = fragment.firstChild;\n      if (firstChild instanceof SVGElement) {\n        this.spriteSVG = firstChild;\n        this.fileContainer.shadowRoot?.appendChild(this.spriteSVG);\n      }\n    }\n    return this.fileContainer;\n  }\n\n  getFileContainer(): HTMLElement | undefined {\n    return this.fileContainer;\n  }\n\n  private getOrCreatePre(container: HTMLElement): HTMLPreElement {\n    // If we haven't created a pre element yet, lets go ahead and do that\n    if (this.pre == null) {\n      this.pre = document.createElement('pre');\n      container.shadowRoot?.appendChild(this.pre);\n    }\n    // If we have a new parent container for the pre element, lets go ahead and\n    // move it into the new container\n    else if (this.pre.parentNode !== container) {\n      container.shadowRoot?.appendChild(this.pre);\n    }\n    return this.pre;\n  }\n\n  private applyHeaderToDOM(headerAST: Element, container: HTMLElement): void {\n    const tempDiv = document.createElement('div');\n    tempDiv.innerHTML = this.headerRenderer.renderResultToHTML(headerAST);\n    const newHeader = tempDiv.firstElementChild;\n    if (!(newHeader instanceof HTMLElement)) {\n      return;\n    }\n    if (this.headerElement != null) {\n      container.shadowRoot?.replaceChild(newHeader, this.headerElement);\n    } else {\n      container.shadowRoot?.prepend(newHeader);\n    }\n    this.headerElement = newHeader;\n\n    if (this.isContainerManaged) return;\n\n    const { renderHeaderMetadata } = this.options;\n    if (this.headerMetadata != null) {\n      this.headerMetadata.parentNode?.removeChild(this.headerMetadata);\n    }\n    const content =\n      renderHeaderMetadata?.({\n        oldFile: this.oldFile,\n        newFile: this.newFile,\n        fileDiff: this.fileDiff,\n      }) ?? undefined;\n    if (content != null) {\n      this.headerMetadata = document.createElement('div');\n      this.headerMetadata.slot = HEADER_METADATA_SLOT_ID;\n      if (content instanceof Element) {\n        this.headerMetadata.appendChild(content);\n      } else {\n        this.headerMetadata.innerText = `${content}`;\n      }\n      container.appendChild(this.headerMetadata);\n    }\n  }\n\n  private setPreAttributes(\n    pre: HTMLPreElement,\n    highlighter: PJSHighlighter,\n    result: HunksRenderResult\n  ): void {\n    const {\n      diffStyle = 'split',\n      overflow = 'scroll',\n      theme,\n      themeType = 'system',\n      diffIndicators = 'bars',\n      disableBackground = false,\n    } = this.options;\n    const unified = diffStyle === 'unified';\n    const split = unified\n      ? false\n      : result.additionsAST != null && result.deletionsAST != null;\n    const wrap = overflow === 'wrap';\n    setWrapperProps({\n      pre,\n      theme,\n      highlighter,\n      split,\n      wrap,\n      themeType,\n      diffIndicators,\n      disableBackground,\n      totalLines: result.totalLines,\n    });\n  }\n\n  private injectUnsafeCSS(): void {\n    if (this.fileContainer?.shadowRoot == null) {\n      return;\n    }\n    const { unsafeCSS } = this.options;\n\n    if (unsafeCSS == null || unsafeCSS === '') {\n      return;\n    }\n\n    // Create or update the style element\n    if (this.unsafeCSSStyle == null) {\n      this.unsafeCSSStyle = document.createElement('style');\n      this.fileContainer.shadowRoot.appendChild(this.unsafeCSSStyle);\n    }\n    // Wrap in @layer unsafe to match SSR behavior\n    this.unsafeCSSStyle.insertAdjacentText(\n      'beforeend',\n      `@layer unsafe {\\n${unsafeCSS}\\n}`\n    );\n  }\n\n  private applyHunksToDOM(\n    result: HunksRenderResult,\n    pre: HTMLPreElement,\n    highlighter: PJSHighlighter\n  ): void {\n    this.setPreAttributes(pre, highlighter, result);\n\n    // Clear existing content\n    pre.innerHTML = '';\n\n    let codeDeletions: HTMLElement | undefined;\n    let codeAdditions: HTMLElement | undefined;\n    // Create code elements and insert HTML content\n    if (result.unifiedAST != null) {\n      const codeUnified = createCodeNode({ columnType: 'unified' });\n      codeUnified.innerHTML = this.hunksRenderer.renderPartialHTML(\n        result.unifiedAST\n      );\n      pre.appendChild(codeUnified);\n    } else {\n      if (result.deletionsAST != null) {\n        codeDeletions = createCodeNode({ columnType: 'deletions' });\n        codeDeletions.innerHTML = this.hunksRenderer.renderPartialHTML(\n          result.deletionsAST\n        );\n        pre.appendChild(codeDeletions);\n      }\n      if (result.additionsAST != null) {\n        codeAdditions = createCodeNode({ columnType: 'additions' });\n        codeAdditions.innerHTML = this.hunksRenderer.renderPartialHTML(\n          result.additionsAST\n        );\n        pre.appendChild(codeAdditions);\n      }\n    }\n\n    this.injectUnsafeCSS();\n\n    this.mouseEventManager.setup(pre);\n    if ((this.options.overflow ?? 'scroll') === 'scroll') {\n      this.resizeManager.setup(pre);\n      this.scrollSyncManager.setup(pre, codeDeletions, codeAdditions);\n    } else {\n      this.resizeManager.cleanUp();\n      this.scrollSyncManager.cleanUp();\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;AAuDA,IAAI,aAAa;AAEjB,IAAa,WAAb,MAA+C;CAG7C,OAAO,wBAAiC;CAExC,AAAS,OAAe,EAAE;CAE1B,AAAQ;CACR,AAAQ;CACR,AAAQ;CACR,AAAQ;CAER,AAAQ;CACR,AAAQ;CACR,AAAQ,qBAAoC,EAAE;CAE9C,AAAQ;CACR,AAAQ;CACR,AAAQ;CACR,AAAQ;CACR,AAAQ;CAER,AAAQ,qBAAoC,EAAE;CAC9C,AAAQ,kBAAqD,EAAE;CAE/D,AAAQ;CACR,AAAQ;CACR,AAAQ;CAER,YACE,AAAOA,UAAwC,EAAE,OAAO,gBAAgB,EAExE,AAAQ,qBAAqB,OAC7B;EAHO;EAEC;AAER,OAAK,gBAAgB,IAAI,kBAAkB;GACzC,GAAG;GACH,gBACE,OAAO,QAAQ,mBAAmB,aAC9B,WACA,QAAQ;GACf,CAAC;AACF,OAAK,iBAAiB,IAAI,mBAAmB,QAAQ;AACrD,OAAK,gBAAgB,IAAI,eAAe;AACxC,OAAK,oBAAoB,IAAI,mBAAmB;AAChD,OAAK,oBAAoB,IAAI,kBAC3B,QACA,qBACE,SACA,OAAO,QAAQ,mBAAmB,eAC/B,QAAQ,kBAAkB,iBAAiB,cAC1C,KAAK,mBACL,OACL,CACF;;CAUH,WAAW,SAAyD;AAClE,MAAI,WAAW,KAAM;AACrB,OAAK,UAAU;AACf,OAAK,cAAc,WAAW;GAC5B,GAAG,KAAK;GACR,gBACE,OAAO,QAAQ,mBAAmB,aAC9B,WACA,QAAQ;GACf,CAAC;AACF,OAAK,kBAAkB,WACrB,qBACE,SACA,OAAO,QAAQ,mBAAmB,eAC/B,QAAQ,kBAAkB,iBAAiB,cAC1C,KAAK,mBACL,OACL,CACF;;CAGH,AAAQ,aAAa,SAAsD;AACzE,OAAK,UAAU;GAAE,GAAG,KAAK;GAAS,GAAG;GAAS;;CAGhD,aAAa,WAA6B;AACxC,OAAK,KAAK,QAAQ,aAAa,cAAc,UAC3C;AAEF,OAAK,aAAa,EAAE,WAAW,CAAC;AAChC,OAAK,cAAc,aAAa,UAAU;AAC1C,OAAK,eAAe,aAAa,UAAU;AAE3C,MAAI,KAAK,iBAAiB,KACxB,KAAI,cAAc,SAChB,QAAO,KAAK,cAAc,QAAQ;MAElC,MAAK,cAAc,QAAQ,YAAY;AAK3C,MAAI,KAAK,OAAO,KACd,SAAQ,WAAR;GACE,KAAK;AACH,WAAO,KAAK,IAAI,QAAQ;AACxB;GACF,KAAK;GACL,KAAK;AACH,SAAK,IAAI,QAAQ,YAAY;AAC7B;;;CAKR,mBAAmB,iBAA0D;AAC3E,OAAK,kBAAkB;;CAGzB,UAAgB;AACd,OAAK,cAAc,SAAS;AAC5B,OAAK,eAAe,SAAS;AAC7B,OAAK,cAAc,SAAS;AAC5B,OAAK,kBAAkB,SAAS;AAChC,OAAK,kBAAkB,SAAS;AAGhC,OAAK,WAAW;AAChB,OAAK,UAAU;AACf,OAAK,UAAU;AAGf,MAAI,CAAC,KAAK,mBACR,MAAK,eAAe,YAAY,YAAY,KAAK,cAAc;AAEjE,OAAK,gBAAgB;AACrB,OAAK,MAAM;AACX,OAAK,gBAAgB;;CAGvB,MAAM,QAAQ,OAAwD;AACpE,MAAI,MAAM,iBAAiB,KACzB,OAAM,IAAI,MACR,0DACD;AAEH,OAAK,MAAM,WAAW,MAAM,KAC1B,MAAM,cAAc,YAAY,YAAY,EAAE,CAC/C,EAAE;AACD,OAAI,mBAAmB,YAAY;AACjC,SAAK,YAAY;AACjB;;AAEF,OAAI,EAAE,mBAAmB,aACvB;AAEF,OAAI,mBAAmB,gBAAgB;AACrC,SAAK,MAAM;AACX;;AAEF,OAAI,eAAe,QAAQ,SAAS;AAClC,SAAK,gBAAgB;AACrB;;AAEF,OAAI,mBAAmB,kBAAkB;AACvC,SAAK,iBAAiB;AACtB;;;AAIJ,MAAI,KAAK,OAAO,KACd,OAAM,KAAK,OAAO,MAAM;OAGrB;AACH,QAAK,gBAAgB,MAAM;AAC3B,UAAO,KAAK,IAAI,QAAQ;AAExB,QAAK,kBAAkB,MAAM,mBAAmB,KAAK;AACrD,QAAK,UAAU,MAAM;AACrB,QAAK,UAAU,MAAM;AACrB,QAAK,WAAW,MAAM;AAEtB,GAAK,KAAK,cAAc,uBAAuB;AAG/C,QAAK,mBAAmB;AACxB,QAAK,iBAAiB;AACtB,QAAK,kBAAkB,MAAM,KAAK,IAAI;AACtC,QAAK,KAAK,QAAQ,YAAY,cAAc,UAAU;AACpD,SAAK,cAAc,MAAM,KAAK,IAAI;AAClC,SAAK,kBAAkB,MAAM,KAAK,IAAI;;;;CAK5C,MAAM,WAA0B;AAC9B,QAAM,KAAK,OAAO;GAChB,SAAS,KAAK;GACd,SAAS,KAAK;GACd,UAAU,KAAK;GACf,aAAa;GACd,CAAC;;CAGJ,oBAAoB,cAA4B;AAC9C,OAAK,cAAc,WAAW,UAAU;AACxC,EAAK,KAAK,UAAU;;CAGtB,MAAM,OAAO,EACX,SACA,SACA,UACA,eACA,cAAc,OACd,iBACA,oBACkD;EAClD,MAAM,qBACJ,mBAAmB,QAGnB,CAAC,WAAW,iBAAiB,KAAK,gBAAgB;AACpD,MACE,CAAC,eACD,WAAW,QACX,WAAW,QACX,CAAC,sBACD,WAAW,SAAS,KAAK,QAAQ,IACjC,WAAW,SAAS,KAAK,QAAQ,CAEjC;AAEF,MACE,CAAC,eACD,YAAY,QACZ,aAAa,KAAK,YAClB,CAAC,mBAED;AAGF,OAAK,UAAU;AACf,OAAK,UAAU;AACf,MAAI,YAAY,KACd,MAAK,WAAW;WACP,WAAW,QAAQ,WAAW,KACvC,MAAK,WAAW,kBAAkB,SAAS,QAAQ;AAGrD,MAAI,mBAAmB,KACrB,MAAK,mBAAmB,gBAAgB;AAE1C,MAAI,KAAK,YAAY,KACnB;AAEF,OAAK,cAAc,WAAW;GAC5B,GAAG,KAAK;GACR,gBACE,OAAO,KAAK,QAAQ,mBAAmB,aACnC,WACA,KAAK,QAAQ;GACpB,CAAC;AAGF,OAAK,cAAc,mBAAmB,KAAK,gBAAgB;EAE3D,MAAM,EAAE,oBAAoB,UAAU,KAAK;AAE3C,MAAI,mBAAmB;AACrB,QAAK,eAAe,SAAS;AAE7B,OAAI,KAAK,iBAAiB,MAAM;AAC9B,SAAK,cAAc,YAAY,YAAY,KAAK,cAAc;AAC9D,SAAK,gBAAgB;;SAElB;GACL,MAAM,EAAE,OAAO,cAAc,KAAK;AAClC,QAAK,eAAe,WAAW;IAAE;IAAO;IAAW,CAAC;;EAGtD,MAAM,CAAC,aAAa,cAAc,eAAe,MAAM,QAAQ,IAAI;GACjE,qBAAqB;IACnB,QAAQ,UAAU,KAAK,QAAQ,MAAM;IACrC,OAAO,EAAE;IACV,CAAC;GACF,CAAC,oBACG,KAAK,eAAe,OAAO,KAAK,SAAS,GACzC;GACJ,KAAK,cAAc,OAAO,KAAK,SAAS;GACzC,CAAC;AAGF,MAAI,gBAAgB,QAAQ,eAAe,KACzC;AAGF,kBAAgB,KAAK,yBAAyB,cAAc;AAC5D,MAAI,gBAAgB,KAClB,MAAK,iBAAiB,cAAc,cAAc;AAEpD,MAAI,eAAe,MAAM;AACvB,OAAI,oBAAoB,KACtB,kBAAiB,YAAY,cAAc;GAE7C,MAAM,MAAM,KAAK,eAAe,cAAc;AAC9C,QAAK,gBAAgB,aAAa,KAAK,YAAY;AACnD,QAAK,iBAAiB,YAAY,SAAS;AAC3C,QAAK,mBAAmB;;;CAI5B,AAAQ,iBAAiB,UAA4B;EACnD,MAAM,EAAE,mBAAmB,KAAK;AAChC,MACE,KAAK,sBACL,KAAK,iBAAiB,QACtB,OAAO,mBAAmB,WAE1B;AAEF,OAAK,MAAM,WAAW,KAAK,mBACzB,SAAQ,YAAY,YAAY,QAAQ;AAE1C,OAAK,mBAAmB,SAAS;AACjC,OAAK,MAAM,QAAQ,UAAU;GAC3B,MAAM,UAAU,SAAS,cAAc,MAAM;AAC7C,WAAQ,MAAM,UAAU;AACxB,WAAQ,OAAO,KAAK;AACpB,WAAQ,YAAY,eAAe,KAAK,CAAC;AACzC,QAAK,cAAc,YAAY,QAAQ;AACvC,QAAK,mBAAmB,KAAK,QAAQ;;;CAIzC,AAAQ,oBAA0B;AAChC,MAAI,KAAK,sBAAsB,KAAK,iBAAiB,KACnD;AAGF,OAAK,MAAM,WAAW,KAAK,mBACzB,SAAQ,YAAY,YAAY,QAAQ;AAE1C,OAAK,mBAAmB,SAAS;EAEjC,MAAM,EAAE,qBAAqB,KAAK;AAClC,MAAI,oBAAoB,QAAQ,KAAK,gBAAgB,SAAS,EAC5D,MAAK,MAAM,cAAc,KAAK,iBAAiB;GAC7C,MAAM,UAAU,iBAAiB,WAAW;AAC5C,OAAI,WAAW,KAAM;GACrB,MAAM,KAAK,SAAS,cAAc,MAAM;AACxC,MAAG,QAAQ,iBAAiB;AAC5B,MAAG,OAAO,sBAAsB,WAAW;AAC3C,MAAG,YAAY,QAAQ;AACvB,QAAK,mBAAmB,KAAK,GAAG;AAChC,QAAK,cAAc,YAAY,GAAG;;;CAKxC,AAAQ,yBAAyB,eAA0C;AACzE,OAAK,gBACH,iBACA,KAAK,iBACL,SAAS,cAAc,YAAY;AACrC,MAAI,KAAK,aAAa,MAAM;GAC1B,MAAM,WAAW,SAAS,cAAc,MAAM;AAC9C,YAAS,YAAY;GACrB,MAAM,aAAa,SAAS;AAC5B,OAAI,sBAAsB,YAAY;AACpC,SAAK,YAAY;AACjB,SAAK,cAAc,YAAY,YAAY,KAAK,UAAU;;;AAG9D,SAAO,KAAK;;CAGd,mBAA4C;AAC1C,SAAO,KAAK;;CAGd,AAAQ,eAAe,WAAwC;AAE7D,MAAI,KAAK,OAAO,MAAM;AACpB,QAAK,MAAM,SAAS,cAAc,MAAM;AACxC,aAAU,YAAY,YAAY,KAAK,IAAI;aAIpC,KAAK,IAAI,eAAe,UAC/B,WAAU,YAAY,YAAY,KAAK,IAAI;AAE7C,SAAO,KAAK;;CAGd,AAAQ,iBAAiB,WAAoB,WAA8B;EACzE,MAAM,UAAU,SAAS,cAAc,MAAM;AAC7C,UAAQ,YAAY,KAAK,eAAe,mBAAmB,UAAU;EACrE,MAAM,YAAY,QAAQ;AAC1B,MAAI,EAAE,qBAAqB,aACzB;AAEF,MAAI,KAAK,iBAAiB,KACxB,WAAU,YAAY,aAAa,WAAW,KAAK,cAAc;MAEjE,WAAU,YAAY,QAAQ,UAAU;AAE1C,OAAK,gBAAgB;AAErB,MAAI,KAAK,mBAAoB;EAE7B,MAAM,EAAE,yBAAyB,KAAK;AACtC,MAAI,KAAK,kBAAkB,KACzB,MAAK,eAAe,YAAY,YAAY,KAAK,eAAe;EAElE,MAAM,UACJ,uBAAuB;GACrB,SAAS,KAAK;GACd,SAAS,KAAK;GACd,UAAU,KAAK;GAChB,CAAC,IAAI;AACR,MAAI,WAAW,MAAM;AACnB,QAAK,iBAAiB,SAAS,cAAc,MAAM;AACnD,QAAK,eAAe,OAAO;AAC3B,OAAI,mBAAmB,QACrB,MAAK,eAAe,YAAY,QAAQ;OAExC,MAAK,eAAe,YAAY,GAAG;AAErC,aAAU,YAAY,KAAK,eAAe;;;CAI9C,AAAQ,iBACN,KACA,aACA,QACM;EACN,MAAM,EACJ,YAAY,SACZ,WAAW,UACX,OACA,YAAY,UACZ,iBAAiB,QACjB,oBAAoB,UAClB,KAAK;AAMT,kBAAgB;GACd;GACA;GACA;GACA,OATc,cAAc,YAE1B,QACA,OAAO,gBAAgB,QAAQ,OAAO,gBAAgB;GAOxD,MANW,aAAa;GAOxB;GACA;GACA;GACA,YAAY,OAAO;GACpB,CAAC;;CAGJ,AAAQ,kBAAwB;AAC9B,MAAI,KAAK,eAAe,cAAc,KACpC;EAEF,MAAM,EAAE,cAAc,KAAK;AAE3B,MAAI,aAAa,QAAQ,cAAc,GACrC;AAIF,MAAI,KAAK,kBAAkB,MAAM;AAC/B,QAAK,iBAAiB,SAAS,cAAc,QAAQ;AACrD,QAAK,cAAc,WAAW,YAAY,KAAK,eAAe;;AAGhE,OAAK,eAAe,mBAClB,aACA,oBAAoB,UAAU,KAC/B;;CAGH,AAAQ,gBACN,QACA,KACA,aACM;AACN,OAAK,iBAAiB,KAAK,aAAa,OAAO;AAG/C,MAAI,YAAY;EAEhB,IAAIC;EACJ,IAAIC;AAEJ,MAAI,OAAO,cAAc,MAAM;GAC7B,MAAM,cAAc,eAAe,EAAE,YAAY,WAAW,CAAC;AAC7D,eAAY,YAAY,KAAK,cAAc,kBACzC,OAAO,WACR;AACD,OAAI,YAAY,YAAY;SACvB;AACL,OAAI,OAAO,gBAAgB,MAAM;AAC/B,oBAAgB,eAAe,EAAE,YAAY,aAAa,CAAC;AAC3D,kBAAc,YAAY,KAAK,cAAc,kBAC3C,OAAO,aACR;AACD,QAAI,YAAY,cAAc;;AAEhC,OAAI,OAAO,gBAAgB,MAAM;AAC/B,oBAAgB,eAAe,EAAE,YAAY,aAAa,CAAC;AAC3D,kBAAc,YAAY,KAAK,cAAc,kBAC3C,OAAO,aACR;AACD,QAAI,YAAY,cAAc;;;AAIlC,OAAK,iBAAiB;AAEtB,OAAK,kBAAkB,MAAM,IAAI;AACjC,OAAK,KAAK,QAAQ,YAAY,cAAc,UAAU;AACpD,QAAK,cAAc,MAAM,IAAI;AAC7B,QAAK,kBAAkB,MAAM,KAAK,eAAe,cAAc;SAC1D;AACL,QAAK,cAAc,SAAS;AAC5B,QAAK,kBAAkB,SAAS"}