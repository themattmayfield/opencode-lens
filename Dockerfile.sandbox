# Dockerfile for OpenCode sandbox environments
# This image is used by E2B or other sandbox providers to run OpenCode with GitHub repos

FROM oven/bun:1-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create workspace directory
RUN mkdir -p /home/user/repo
WORKDIR /home/user

# Install OpenCode globally (replace with actual installation method)
# For now, this is a placeholder - you'll need to adapt based on how OpenCode is distributed
# Option 1: Install from npm/registry
# RUN bun add -g @opencode-ai/cli

# Option 2: Copy from build
# COPY --from=builder /app/packages/opencode /usr/local/opencode
# RUN cd /usr/local/opencode && bun install --production
# RUN ln -s /usr/local/opencode/bin/opencode /usr/local/bin/opencode

# Copy startup script
COPY scripts/sandbox-init.sh /usr/local/bin/sandbox-init
RUN chmod +x /usr/local/bin/sandbox-init

# Set working directory to repo
WORKDIR /home/user/repo

# Expose OpenCode server port
EXPOSE 4096

# Default command (can be overridden by E2B)
CMD ["sandbox-init"]
